{% extends "pos/base.html" %}
{% block title %}Receipt #<span id="receipt-title"></span>{% endblock %}
{% block page_title %}Receipt #<span id="receipt-title"></span>{% endblock %}
{% block content %}
<div class="bg-white p-6 rounded shadow max-w-2xl mx-auto receipt-content">
  <div class="flex justify-between items-start mb-2">
    <div>
      <h2 class="text-xl font-bold">{{ sale.branch.name }}</h2>
    </div>
    <div class="text-right">
      <div class="font-semibold">Receipt #<span id="receipt-number"></span></div>
    </div>
  </div>
  <div class="flex justify-between mb-4">
    <div>
      <p class="text-sm">Phone: {{ sale.branch.phone }}</p>
      <p class="text-sm">{{ sale.branch.address }}</p>
    </div>
    <div class="text-right">
      <div class="text-sm">{{ sale.created_at }}</div>
    </div>
  </div>

  <hr class="my-4">

  <table class="w-full text-sm">
    <thead>
      <tr class="text-left text-gray-600">
        <th>Item</th><th>Qty</th><th>Unit</th><th class="text-right">Line</th>
      </tr>
    </thead>
    <tbody>
      {% for it in sale.items.all %}
        <tr>
          <td>{{ it.product.name }}</td>
          <td>{{ it.qty }}</td>
          <td>KES {{ it.unit_price }}</td>
          <td class="text-right">KES {{ it.line_total }}</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="mt-4 text-right font-semibold">
    Total: KES {{ sale.total }}
  </div>

  <div class="mt-6 flex justify-end space-x-3 print-buttons">
    <button onclick="window.print()" class="px-3 py-2 rounded bg-green-800 text-white">Print / Save PDF</button>
    <a href="{% url 'pos:dashboard' %}" class="px-3 py-2 rounded bg-gray-200">Close</a>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const branchName = "{{ sale.branch.name | escapejs }}";
  const createdAtStr = "{{ sale.created_at | escapejs }}";
  const saleId = {{ sale.id }};

  // Parse the created_at datetime string to extract components
  const date = new Date(createdAtStr);
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const yearLast2 = String(date.getFullYear()).slice(-2);

  // Store name initials: first 3 characters of the first word, uppercased
  const storeInitials = branchName.split(' ')[0].substring(0, 3).toUpperCase();

  // Incrementing number: pad sale.id to 3 digits (note: this uses global sale.id; for daily reset, backend should provide a daily sequence number)
  const incrementNum = String(saleId).padStart(3, '0');

  // Construct the receipt number
  const receiptNum = `${storeInitials}/${month}/${day}/${yearLast2}/${incrementNum}`;

  // Set the receipt number in the content
  document.getElementById('receipt-number').textContent = receiptNum;

  // Also update the title spans for consistency
  const titleSpans = document.querySelectorAll('#receipt-title');
  titleSpans.forEach(span => span.textContent = receiptNum);
});
</script>

<style>
  @media print {
    @page {
      margin: 0.5cm;
    }
    /* Hide headers, footers, and other non-receipt elements */
    header, footer, nav, aside, .sidebar, .flash-container, .print-buttons, .page-title, h1 {
      display: none !important;
    }
    /* Ensure receipt content takes full width and is visible */
    .receipt-content {
      max-width: none !important;
      width: 100% !important;
      margin: 0 !important;
      padding: 10px !important;
      box-shadow: none !important;
      border-radius: 0 !important;
      position: static !important;
      display: block !important;
    }
    body {
      margin: 0 !important;
      padding: 0 !important;
      font-size: 12pt !important;
    }
    /* Compact styles for thermal printing */
    .receipt-content table {
      font-size: 10pt;
      width: 100%;
    }
    .receipt-content th, .receipt-content td {
      padding: 4px;
      border-bottom: 1px solid #ccc;
    }
    .receipt-content h2 {
      font-size: 14pt;
      margin-bottom: 5px;
    }
    .receipt-content p {
      margin: 2px 0;
      font-size: 9pt;
    }
    /* Prevent page breaks inside table */
    .receipt-content table {
      page-break-inside: avoid;
    }
  }
</style>
{% endblock %}