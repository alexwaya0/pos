{% extends "pos/base.html" %}
{% block title %}Receipt #<span id="receipt-title"></span>{% endblock %}
{% block page_title %}Receipt #<span id="receipt-title"></span>{% endblock %}
{% block content %}
<div class="bg-white p-6 rounded shadow max-w-2xl mx-auto receipt-container">
    <div class="receipt-content">
        <div class="mb-4 text-center">
            <h2 class="text-2xl font-extrabold mb-0 business-name">{{ sale.branch.name }}</h2>
            <p class="text-xs">Mobile: {{ sale.branch.phone }}</p>
            <p class="text-xs">{{ sale.branch.address }}</p>
        </div>

        <hr class="my-2 border-gray-400">

        <div class="text-xs leading-tight detail-section print-left-aligned">
            <div class="detail-row">
                <span class="detail-label font-semibold">Receipt#:</span>
                <span id="receipt-number" class="detail-value"></span>
            </div>
            <div class="detail-row">
                <span class="detail-label font-semibold">Date/Time:</span>
                <span class="detail-value">{{ sale.created_at|date:"Y-m-d H:i" }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label font-semibold">Served by:</span>
                <span class="detail-value">{{ user.first_name }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label font-semibold">Paid:</span>
                <span class="detail-value">Cash</span>
            </div>
        </div>

        <hr class="my-2 border-gray-400">

        <table class="w-full text-xs table-fixed item-table">
            <thead>
                <tr class="text-left font-bold text-black border-b border-gray-400">
                    <th class="w-[10%] p-0">#</th>
                    <th class="w-[45%] p-0">ITEM</th>
                    <th class="w-[10%] p-0">QTY</th>
                    <th class="w-[15%] p-0 text-right">U/P</th>
                    <th class="w-[20%] p-0 text-right">SUB</th>
                </tr>
            </thead>
            <tbody>
                {% for it in sale.items.all %}
                <tr class="leading-snug">
                    <td>{{ forloop.counter }}</td>
                    <td>{{ it.product.name }}</td> 
                    <td>{{ it.qty|floatformat:"0" }}</td>
                    <td class="text-right">{{ it.unit_price|floatformat:"1" }}</td>
                    <td class="text-right">{{ it.line_total|floatformat:"1" }}</td>
                </tr>
                {% endfor %}
                <tr class="blank-row-large"><td colspan="5"></td></tr>
            </tbody>
        </table>

        <div class="text-sm font-bold totals-section totals-boxed">
            <div class="border-top-line"></div> 
            <div class="flex py-2 total-row">
                <span class="w-[80%] font-extrabold text-right total-label">**TOTAL (KES):**</span>
                <span class="w-[20%] text-right font-extrabold total-figure">{{ sale.total|floatformat:"1" }}</span>
            </div>
             <div class="border-bottom-line"></div> 
        </div>

        <hr class="my-2 border-gray-400">

        <div class="mt-4 text-center">
            <p class="text-xs font-semibold mb-1">Our Motto: Your Health Our Priority</p>
            <p class="text-3xs mt-1 legal-notice">NO REFUNDS ONCE SOLD.</p>
        </div>

    </div>

    <div class="mt-6 flex justify-end print-buttons">
        <button onclick="printReceipt()" class="px-5 py-2 rounded bg-green-800 text-white font-bold">Print</button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const branchName = "{{ sale.branch.name | escapejs }}";
    const createdAtStr = "{{ sale.created_at | escapejs }}";
    const saleId = {{ sale.id }};
    const date = new Date(createdAtStr);
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const yearLast2 = String(date.getFullYear()).slice(-2);
    const storeInitials = branchName.split(' ')[0].substring(0, 3).toUpperCase();
    const incrementNum = String(saleId).padStart(3, '0');
    const receiptNum = `${storeInitials}${month}${day}${yearLast2}${incrementNum}`;

    document.getElementById('receipt-number').textContent = receiptNum;
    document.querySelectorAll('#receipt-title').forEach(span => span.textContent = receiptNum);

    // Self-destruct Django messages
    setTimeout(function() {
        document.querySelectorAll('.flash-container, .messages, div.messages, .alert, .alerts').forEach(msg => {
            if (msg) msg.remove();
        });
    }, 10);
});

function printReceipt() {
    // Note: The printReceipt function is simplified as there's no preview mode toggle anymore
    window.print();
}

// Removed togglePreviewMode function as it's no longer used.
</script>

<style>
/* ------------------------------------------- */
/* --- SCREEN/PREVIEW STYLES (80mm Emulation)--- */
/* ------------------------------------------- */
.receipt-container {
    font-family: 'Courier New', Courier, monospace; 
    max-width: 48rem;
    transition: max-width 0.3s;
}

/* Removed thermal-preview class logic as the toggle button is gone */

.flash-container, .messages, div.messages, .alert, .alerts {
    display: none !important;
}

.detail-section .detail-row {
    display: flex;
    justify-content: space-between;
}
.detail-section .detail-label {
    min-width: 80px;
}

/* ------------------------------------------- */
/* --- PRINT STYLES (7pt Base, Final) --- */
/* ------------------------------------------- */
@media print {
    @page {
        size: 80mm auto; 
        margin: 0.1cm;
    }

    /* General Print Overrides */
    header, footer, nav, aside, .sidebar, .flash-container, .messages, div.messages, .alert, .alerts, .print-buttons, .page-title, h1 {
        display: none !important;
    }
    
    body {
        font-family: 'Courier New', Courier, monospace !important;
        font-size: 7pt !important;
        margin: 0 !important;
        padding: 0 !important;
        width: 100% !important;
        overflow: hidden !important;
    }

    .receipt-container, .receipt-content {
        max-width: 100% !important;
        width: 100% !important; 
        margin: 0 !important;
        padding: 0 !important;
        box-shadow: none !important;
        border-radius: 0 !important;
    }
    
    .receipt-content * {
        text-align: left !important;
        line-height: 1.2;
    }

    /* 1. Header Styling */
    .receipt-content .business-name {
        font-size: 11pt !important;
        font-weight: 900 !important;
        margin-bottom: 2px !important;
    }

    /* 2. Table and Details (7pt base) */
    .receipt-content .detail-section, .receipt-content .item-table, .receipt-content th, .receipt-content td {
        font-size: 7pt !important;
    }
    
    /* Blank row height */
    .receipt-content .blank-row-large td {
        padding: 6px 0 !important;
    }

    /* 3. Boxed TOTAL */
    .receipt-content .totals-section {
        font-size: 9pt !important;
    }
    .receipt-content .totals-boxed {
        margin: 5px 0 0 0 !important;
    }

    /* Custom borders for the total box */
    .receipt-content .border-top-line, 
    .receipt-content .border-bottom-line {
        border-top: 2px solid #000 !important;
        margin: 0 !important;
        padding: 0 !important;
        height: 0 !important;
    }
    .receipt-content .total-figure, .receipt-content .total-label {
        font-weight: 900 !important;
    }

    /* Total Alignment */
    .receipt-content .totals-section .total-row {
        display: flex;
        width: 100%;
        margin-top: 2px;
        font-weight: bold !important;
    }
    .receipt-content .totals-section .total-row .w-\[80\%\] {
        width: 80% !important;
        text-align: right !important;
    }
    .receipt-content th.text-right, .receipt-content td.text-right {
        text-align: right !important;
    }

    /* 4. Footer and Legal Notice */
    .receipt-content .legal-notice {
        font-size: 6pt !important;
        margin-top: 1px !important;
    }

    /* HR Lines */
    hr {
        border-color: #000 !important;
        border-width: 1px 0 0 0 !important;
        margin: 3px 0 !important;
        height: 0 !important;
    }
}
</style>
{% endblock %}