{% extends 'pos/base.html' %}
{% load humanize %}
{% block title %}New Sale{% endblock %}
{% block page_title %}Create New Sale{% endblock %}
{% block content %}
<style>
  .dashboard-container {
    animation: fadeSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    opacity: 0;
    transform: translateY(10px);
  }
  @keyframes fadeSlideIn {
    to { opacity: 1; transform: translateY(0); }
  }
  .card {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: none;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08), 0 1px 3px rgba(0, 0, 0, 0.1);
    position: relative;
    padding: 20px;
    overflow: hidden;
    backdrop-filter: blur(10px);
  }
  .card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--gold), var(--darkgreen));
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  .card:hover {
    transform: translateY(-4px) scale(1.02);
    box-shadow: 0 12px 40px rgba(6, 68, 32, 0.15), 0 2px 8px rgba(0, 0, 0, 0.1);
  }
  .card:hover::before { opacity: 1; }
  .card-basic { 
    background: linear-gradient(145deg, #FFFFFF 0%, #F8FAFC 50%, rgba(248, 250, 252, 0.8) 100%); 
    border: 1px solid rgba(226, 232, 240, 0.5);
  }
  .card-items { 
    background: linear-gradient(145deg, #FEF2F2 0%, #FEE2E2 50%, rgba(254, 226, 226, 0.8) 100%); 
    border: 1px solid rgba(239, 68, 68, 0.1);
  }
  .metric-icon {
    width: 44px;
    height: 44px;
    background: rgba(255, 255, 255, 0.7);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 12px;
    flex-shrink: 0;
    transition: all 0.3s ease;
  }
  .card:hover .metric-icon {
    background: rgba(255, 255, 255, 0.9);
    transform: scale(1.05);
  }
  .metric-title {
    font-size: 0.875rem;
    font-weight: 500;
    color: #6b7280;
    margin: 0 0 4px 0;
    line-height: 1.2;
  }
  .metric-value {
    font-size: 1.875rem;
    font-weight: 700;
    margin: 0;
    line-height: 1.1;
  }
  .form-group {
    margin-bottom: 16px;
  }
  .form-group label {
    display: block;
    font-weight: 500;
    color: var(--darkgreen);
    margin-bottom: 4px;
    font-size: 0.875rem;
  }
  .form-group input, .form-group select, .form-group textarea {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--glass-border);
    border-radius: 8px;
    background: var(--glass-bg);
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
    font-size: 0.875rem;
  }
  .customer-visible-border, .editable-field-border {
    border: 1px solid #d1d5db !important;
  }
  .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
    border-color: var(--gold);
    outline: none;
    box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
  }
  .form-group input[readonly] {
    background-color: #f3f4f6;
    color: #6b7280;
  }
  .customer-fields {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }
  .customer-fields .form-group {
    flex: 1;
    min-width: 200px;
  }
  .table-container {
    background: #ffffff;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    padding: 24px;
    overflow-x: auto;
    margin-bottom: 16px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    min-width: 800px;
  }
  th, td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #f1f5f9;
  }
  th {
    background-color: var(--darkgreen);
    color: #ffffff;
    font-weight: 600;
  }
  tr:hover {
    background-color: #f8fafc;
  }
  .line-total {
    font-weight: 600;
    color: var(--darkgreen);
  }
  .stock-loading {
    color: #6b7280;
    font-style: italic;
  }
  .field-error {
    border-color: #dc2626 !important;
    box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.2), inset 0 0 0 1px rgba(220, 38, 38, 0.1) !important;
    animation: shake 0.6s ease-in-out, pulseError 2s infinite;
  }
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-6px); }
    75% { transform: translateX(6px); }
  }
  @keyframes pulseError {
    0%, 100% { box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.2), inset 0 0 0 1px rgba(220, 38, 38, 0.1); }
    50% { box-shadow: 0 0 0 6px rgba(220, 38, 38, 0.15), inset 0 0 0 1px rgba(220, 38, 38, 0.1); }
  }
  .error-text {
    color: #dc2626;
    font-size: 0.8125rem;
    font-weight: 600;
    margin-top: 4px;
    display: block;
    animation: fadeInError 0.3s ease-out;
    position: relative;
  }
  .error-text:hover::after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: #dc2626;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.75rem;
    white-space: nowrap;
    z-index: 10;
    margin-bottom: 4px;
  }
  @keyframes fadeInError {
    from { opacity: 0; transform: translateY(-2px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .out-of-stock-badge {
    background: #fee2e2;
    color: #dc2626;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: bold;
    border: 1px solid #fecaca;
  }
  .stock-badge {
    background: #f0fdf4;
    color: #16a34a;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: bold;
    border: 1px solid #bbf7d0;
  }
  .insufficient-stock-badge {
    background: #fef2f2;
    color: #dc2626;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: bold;
    border: 1px solid #fecaca;
  }
  .add-item-btn {
    background: linear-gradient(135deg, var(--gold), var(--gold-dark));
    color: var(--darkgreen);
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 0.875rem;
    margin-bottom: 16px;
  }
  .add-item-btn:hover {
    transform: translateY(-1px) scale(1.05);
    box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
  }
  .remove-row {
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    transition: all 0.2s ease;
  }
  .remove-row:hover {
    background: #dc2626;
    transform: scale(1.1);
  }
  .grand-total {
    background: linear-gradient(135deg, var(--darkgreen), #16a34a);
    color: white;
    padding: 16px;
    border-radius: 12px;
    text-align: right;
    font-size: 1.25rem;
    font-weight: 700;
    margin-bottom: 20px;
  }
  .btn-primary {
    background: linear-gradient(135deg, var(--gold), var(--gold-dark));
    color: var(--darkgreen);
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
    font-size: 1rem;
  }
  .btn-primary:hover:not(:disabled) {
    transform: translateY(-1px) scale(1.05);
    box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
  }
  .btn-primary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .btn-secondary {
    background: #6b7280;
    color: white;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
    font-size: 1rem;
    text-decoration: none;
    display: inline-block;
  }
  .btn-secondary:hover {
    background: #4b5563;
    transform: translateY(-1px);
  }
  .actions {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    margin-top: 20px;
  }
  .error-msg {
    background: #fef2f2;
    border: 1px solid #fecaca;
    color: #dc2626;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 16px;
    animation: fadeInError 0.3s ease-out;
  }
  .alert-error {
    background: #fef2f2;
    border: 1px solid #fecaca;
    color: #dc2626;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 16px;
    animation: fadeInError 0.3s ease-out;
  }
  .js-error {
    background: #fef2f2;
    border: 1px solid #fecaca;
    color: #dc2626;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 16px;
    display: none;
    animation: fadeInError 0.3s ease-out;
  }
  /* Responsive */
  @media (max-width: 768px) {
    .customer-fields {
      flex-direction: column;
    }
    .customer-fields .form-group {
      min-width: auto;
    }
    table {
      min-width: 600px;
    }
    .actions {
      flex-direction: column;
    }
    .btn-primary, .btn-secondary {
      width: 100%;
    }
  }
</style>

<div class="dashboard-container container mx-auto px-4">
  {% if messages %}
    {% for message in messages %}
      <div class="alert-error">{{ message }}</div>
    {% endfor %}
  {% endif %}
  {% if form.non_field_errors %}
    <div class="error-msg">
      {{ form.non_field_errors }}
    </div>
  {% endif %}
  {% if form.errors %}
    <div class="error-msg">
      {% for field, errors in form.errors.items %}
        {% if field != '__all__' %}
          <p>{{ field|title }}: {{ errors.0 }}</p>
        {% endif %}
      {% endfor %}
    </div>
  {% endif %}

  <form method="POST" id="sale-form">
    {% csrf_token %}

    <!-- Customer Information Card -->
    <div class="card card-basic mb-6">
      <h3 class="text-lg font-semibold text-var(--darkgreen) mb-4">Customer Information</h3>
      
      {{ form.branch.as_hidden }}
      
      <div class="customer-fields">
        <div class="form-group">
          <label for="{{ form.customer_phone.id_for_label }}">Customer Phone</label>
          <input type="text" name="{{ form.customer_phone.name }}" value="{{ form.customer_phone.value|default:'' }}" class="customer-visible-border" maxlength="30">
          {% if form.customer_phone.errors %}
            <span class="error-text" data-tooltip="{{ form.customer_phone.errors.0 }}">{{ form.customer_phone.errors.0 }}</span>
          {% endif %}
        </div>
        <div class="form-group">
          <label for="{{ form.customer_name.id_for_label }}">Customer Name</label>
          <input type="text" name="{{ form.customer_name.name }}" value="{{ form.customer_name.value|default:'' }}" class="customer-visible-border" maxlength="200">
          {% if form.customer_name.errors %}
            <span class="error-text" data-tooltip="{{ form.customer_name.errors.0 }}">{{ form.customer_name.errors.0 }}</span>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Items Card -->
    <div class="card card-items mb-6">
      <h3 class="text-lg font-semibold text-var(--darkgreen) mb-4">Sale Items</h3>
      <div id="js-error" class="js-error"></div>
      <button type="button" class="add-item-btn" onclick="addItemRow()">
        <i data-lucide="plus" class="w-4 h-4"></i>
        Add Item
      </button>
      <div class="table-container">
        <table id="items-table">
          <thead>
            <tr>
              <th>Product</th>
              <th>Unit Price (KSh)</th>
              <th>Quantity</th>
              <th>Available Stock</th>
              <th>Line Total (KSh)</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="items-tbody">
            <!-- Dynamic rows will be added here -->
          </tbody>
        </table>
      </div>
      <div class="grand-total">
        Total: <span id="grand-total-val">KSh 0.00</span>
      </div>
    </div>

    <!-- Hidden Notes Field -->
    <div style="display: none;">
      {{ form.notes }}
    </div>

    <!-- Actions -->
    <div class="actions">
      <a href="{% url 'pos:dashboard' %}" class="btn-secondary">Cancel</a>
      <button type="submit" class="btn-primary" id="submit-btn" disabled>Complete Sale</button>
    </div>
  </form>
</div>

<script>
  // Render Lucide icons
  lucide.createIcons();

  let itemIndex = 0;
  let debounceTimer;
  const DEBOUNCE_DELAY = 300; // ms

  // Precompute products array for efficient filtering
  const productsArray = [
    {% for product in products %}
      { id: {{ product.id }}, name: "{{ product.name|escapejs }}", price: {{ product.price }}, min_price: {{ product.min_price }} }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];

  const stockMap = new Map();
  const cartQuantities = new Map(); // Track total qty per product across all rows

  // Get branch ID from the hidden form field
  const branchInput = document.querySelector('input[name="branch"]');
  const branchId = branchInput ? parseInt(branchInput.value) || 0 : 0;

  // Prefill if preselected
  {% if preselected_product %}
    addItemRow({{ preselected_product.id }});
  {% endif %}

  // Debounce utility
  function debounce(func, delay) {
    return function(...args) {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => func.apply(this, args), delay);
    };
  }

  function showError(element, message, duration = 5000) {
    const errorDiv = document.getElementById('js-error');
    errorDiv.textContent = message;
    errorDiv.setAttribute('data-tooltip', message);
    errorDiv.style.display = 'block';
    if (duration > 0) {
      setTimeout(() => { errorDiv.style.display = 'none'; }, duration);
    }
  }

  // Preload all stock levels for the branch (now supported by updated view)
  async function preloadStock() {
    if (!branchId) return;
    try {
      const response = await fetch(`/ajax/stock/?branch_id=${branchId}`);
      if (response.ok) {
        const data = await response.json();
        if (data.stocks) {
          data.stocks.forEach(item => {
            stockMap.set(item.product_id, item.available);
          });
        } else if (data.available !== undefined) {
          // In case it returns single, but shouldn't
          console.warn('Unexpected single stock response in preload');
        }
      }
    } catch (error) {
      console.error('Failed to preload stock:', error);
    }
  }

  // Update cart quantities and refresh all relevant stock displays
  function updateCartQuantitiesAndStocks() {
    const rows = document.querySelectorAll('#items-tbody tr');
    rows.forEach((row, idx) => {
      const productSelect = row.querySelector(`select[name="item-${idx}-product_id"]`);
      const qtyInput = row.querySelector(`input[name="item-${idx}-qty"]`);
      const productId = parseInt(productSelect.value);
      const qty = parseInt(qtyInput.value) || 0;

      if (productId) {
        const currentTotal = cartQuantities.get(productId) || 0;
        cartQuantities.set(productId, currentTotal + qty); // This will be overwritten per row, but since we loop all, it's fine
      }
    });

    // Now refresh stock display and validation for all rows
    rows.forEach((row, idx) => {
      validateStock(idx);
      calcLineTotal(idx);
    });
    updateGrandTotal();
    validateForm();
  }

  async function addItemRow(productId = null) {
    try {
      const tbody = document.getElementById('items-tbody');
      if (!tbody) throw new Error('Table body not found');
      
      const row = document.createElement('tr');
      row.id = `item-row-${itemIndex}`;
      row.innerHTML = `
        <td>
          <select name="item-${itemIndex}-product_id" class="product-select editable-field-border" data-index="${itemIndex}" required>
            <option value="">Select a product...</option>
          </select>
        </td>
        <td>
          <input type="number" name="item-${itemIndex}-unit_price" step="0.01" class="price-input editable-field-border" data-index="${itemIndex}" value="0" min="0" required>
          <span class="error-text" id="price-error-${itemIndex}"></span>
        </td>
        <td>
          <input type="number" name="item-${itemIndex}-qty" min="1" class="qty-input editable-field-border" data-index="${itemIndex}" value="1" required>
          <span class="error-text" id="qty-error-${itemIndex}"></span>
        </td>
        <td><span id="available-stock-${itemIndex}">Select Product</span><span class="error-text" id="stock-error-${itemIndex}"></span></td>
        <td><span class="line-total" id="line-total-${itemIndex}">KSh 0.00</span></td>
        <td><button type="button" class="remove-row" data-index="${itemIndex}">×</button></td>
      `;
      tbody.appendChild(row);

      const select = row.querySelector('.product-select');
      const priceInput = row.querySelector('.price-input');
      const qtyInput = row.querySelector('.qty-input');

      // Populate options
      productsArray.forEach(product => {
        const option = document.createElement('option');
        option.value = product.id;
        option.textContent = `${product.name} - KSh ${product.price.toFixed(2)}`;
        option.dataset.price = product.price;
        option.dataset.minPrice = product.min_price;
        select.appendChild(option);
      });

      // Set initial selection if provided
      if (productId) {
        select.value = productId;
        setProductDetails(select);
        await validateStock(itemIndex);
      }

      // Event listeners for realtime updates
      select.addEventListener('change', function() {
        setProductDetails(this);
        updateCartQuantitiesAndStocks();  // Refresh global stock after selection
      });

      // Realtime price validation and calculation
      priceInput.addEventListener('input', () => {
        validatePrice.call(priceInput);
        calcLineTotal(itemIndex);
        updateGrandTotal();
        validateForm();
      });

      // Realtime quantity updates (triggers global stock update, totals, validation)
      qtyInput.addEventListener('input', function() {
        updateCartQuantitiesAndStocks();  // Global update including this change
      });

      itemIndex++;
      updateCartQuantitiesAndStocks();
    } catch (error) {
      console.error('Error adding row:', error);
      showError(null, 'Failed to add item row. Please refresh and try again.', 3000);
    }
  }

  function setProductDetails(select) {
    const index = parseInt(select.dataset.index);
    const selectedOption = select.options[select.selectedIndex];
    const priceInput = document.querySelector(`input[name="item-${index}-unit_price"]`);
    const stockSpan = document.getElementById(`available-stock-${index}`);
    const stockError = document.getElementById(`stock-error-${index}`);

    if (selectedOption.value) {
      priceInput.value = selectedOption.dataset.price;
      priceInput.min = selectedOption.dataset.minPrice;
      validatePrice.call(priceInput);
    } else {
      priceInput.value = '';
      priceInput.min = 0;
      if (stockSpan) {
        stockSpan.innerHTML = '<span style="color: #6b7280;">Select Product</span>';
      }
      if (stockError) {
        stockError.textContent = '';
        stockError.setAttribute('data-tooltip', '');
      }
      document.getElementById(`price-error-${index}`).textContent = '';
      priceInput.classList.remove('field-error');
      calcLineTotal(index);
    }
    updateGrandTotal();
    validateForm();
  }

  function validatePrice() {
    const index = parseInt(this.dataset.index);
    const priceError = document.getElementById(`price-error-${index}`);
    const minPrice = parseFloat(this.min) || 0;
    const currentPrice = parseFloat(this.value) || 0;

    if (currentPrice < minPrice) {
      const message = `Price cannot be below KSh ${minPrice.toFixed(2)}`;
      if (priceError) {
        priceError.textContent = message;
        priceError.setAttribute('data-tooltip', message);
      }
      this.classList.add('field-error');
    } else {
      if (priceError) {
        priceError.textContent = '';
        priceError.setAttribute('data-tooltip', '');
      }
      this.classList.remove('field-error');
    }
    calcLineTotal(index);
    updateGrandTotal();
    validateForm();
  }

  function validateStockQuantity(index, totalQty, available) {
    const qtyInput = document.querySelector(`input[name="item-${index}-qty"]`);
    const stockError = document.getElementById(`stock-error-${index}`);
    const qtyError = document.getElementById(`qty-error-${index}`);

    const qty = parseInt(qtyInput.value) || 0;

    if (totalQty > available && available >= 0) {
      const message = `Total quantity (${totalQty}) exceeds available stock (${available}).`;
      const warning = `Only ${available} available (cart total: ${totalQty}).`;
      if (stockError) {
        stockError.textContent = warning;
        stockError.setAttribute('data-tooltip', warning);
      }
      if (qtyError) {
        qtyError.textContent = message;
        qtyError.setAttribute('data-tooltip', message);
      }
      qtyInput.classList.add('field-error');
      return true; // Has issue
    } else if (qty < 1) {
      const message = 'Quantity must be at least 1.';
      if (qtyError) {
        qtyError.textContent = message;
        qtyError.setAttribute('data-tooltip', message);
      }
      qtyInput.classList.add('field-error');
      if (stockError) {
        stockError.textContent = '';
        stockError.setAttribute('data-tooltip', '');
      }
      return true; // Has issue
    } else {
      if (stockError) {
        stockError.textContent = '';
        stockError.setAttribute('data-tooltip', '');
      }
      if (qtyError) {
        qtyError.textContent = '';
        qtyError.setAttribute('data-tooltip', '');
      }
      qtyInput.classList.remove('field-error');
      return false; // No issue
    }
  }

  async function validateStock(index) {
    try {
      const select = document.querySelector(`select[name="item-${index}-product_id"]`);
      const productId = parseInt(select.value);
      const qtyInput = document.querySelector(`input[name="item-${index}-qty"]`);
      const stockSpan = document.getElementById(`available-stock-${index}`);
      const stockError = document.getElementById(`stock-error-${index}`);
      const qtyError = document.getElementById(`qty-error-${index}`);

      if (!productId || !branchId) {
        if (stockSpan) {
          const msg = !productId ? 'Select Product' : 'No Branch';
          stockSpan.innerHTML = `<span style="color: #6b7280;">${msg}</span>`;
        }
        if (stockError) {
          stockError.textContent = '';
          stockError.setAttribute('data-tooltip', '');
        }
        if (qtyError) {
          qtyError.textContent = '';
          qtyError.setAttribute('data-tooltip', '');
        }
        qtyInput.classList.remove('field-error');
        return false; // No issue
      }

      let available = stockMap.get(productId);
      let fetched = false;

      if (available === undefined) {
        // Fallback to fetch if not preloaded
        if (stockSpan) {
          stockSpan.innerHTML = '<span class="stock-loading">Loading stock...</span>';
        }
        const response = await fetch(`/ajax/stock/?product_id=${productId}&branch_id=${branchId}`);
        if (!response.ok) {
          if (response.status === 404) {
            available = 0;
          } else {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
        } else {
          const data = await response.json();
          available = data.available || 0;
          stockMap.set(productId, available);
          fetched = true;
        }
      }

      const totalCartQty = cartQuantities.get(productId) || 0;
      const remaining = available - totalCartQty;

      if (stockSpan) {
        if (available === 0) {
          stockSpan.innerHTML = '<span class="out-of-stock-badge">Out of Stock</span>';
          if (stockError) {
            stockError.textContent = 'Cannot add items.';
            stockError.setAttribute('data-tooltip', 'Product is out of stock in this branch.');
          }
        } else if (remaining < 0) {
          stockSpan.innerHTML = `<span class="insufficient-stock-badge">Insufficient Stock</span>`;
          if (stockError) {
            stockError.textContent = `Cart exceeds stock by ${Math.abs(remaining)}.`;
            stockError.setAttribute('data-tooltip', `Total cart qty: ${totalCartQty}, Available: ${available}`);
          }
        } else if (remaining > 0) {
          stockSpan.innerHTML = `<span class="stock-badge">${remaining} remaining</span>`;
          if (fetched) {
            stockSpan.classList.remove('stock-loading');
          }
          if (stockError) {
            stockError.textContent = '';
            stockError.setAttribute('data-tooltip', '');
          }
        } else {
          stockSpan.innerHTML = `<span class="stock-badge">0 remaining</span>`;
          if (stockError) {
            stockError.textContent = 'Cart uses all available stock.';
            stockError.setAttribute('data-tooltip', `Total cart qty: ${totalCartQty}, Available: ${available}`);
          }
        }
      }

      // Global quantity validation
      const hasStockIssue = validateStockQuantity(index, totalCartQty, available);
      return hasStockIssue;
    } catch (error) {
      console.error('Stock validation failed:', error);
      const stockSpan = document.getElementById(`available-stock-${index}`);
      const stockError = document.getElementById(`stock-error-${index}`);
      const qtyError = document.getElementById(`qty-error-${index}`);
      const qtyInput = document.querySelector(`input[name="item-${index}-qty"]`);
      if (stockSpan) stockSpan.innerHTML = '<span style="color: #dc2626;">Error loading stock</span>';
      if (stockError) {
        stockError.textContent = 'Stock check failed.';
        stockError.setAttribute('data-tooltip', error.message);
      }
      if (qtyError) {
        qtyError.textContent = '';
        qtyError.setAttribute('data-tooltip', '');
      }
      qtyInput.classList.remove('field-error');
      if (!error.message.includes('404') && !error.message.includes('Network')) {
        showError(null, `Stock check error: ${error.message}. Please check connection.`, 5000);
      }
      return true; // Treat as issue
    }
  }

  function calcLineTotal(index) {
    try {
      const priceInput = document.querySelector(`input[name="item-${index}-unit_price"]`);
      const qtyInput = document.querySelector(`input[name="item-${index}-qty"]`);
      const lineTotalSpan = document.getElementById(`line-total-${index}`);
      if (!lineTotalSpan) return;

      const price = parseFloat(priceInput.value) || 0;
      const qty = parseInt(qtyInput.value) || 0;
      const total = (price * qty).toFixed(2);
      lineTotalSpan.textContent = `KSh ${total}`;
    } catch (error) {
      console.error('Error calculating line total:', error);
    }
  }

  function updateGrandTotal() {
    try {
      let grandTotal = 0;
      const rows = document.querySelectorAll('#items-tbody tr');
      rows.forEach((row, idx) => {
        const lineTotalSpan = document.getElementById(`line-total-${idx}`);
        if (lineTotalSpan) {
          grandTotal += parseFloat(lineTotalSpan.textContent.replace('KSh ', '')) || 0;
        }
      });
      const formattedTotal = grandTotal.toFixed(2);
      document.getElementById('grand-total-val').textContent = `KSh ${formattedTotal}`;
    } catch (error) {
      console.error('Error updating grand total:', error);
    }
  }

  function removeRow(button) {
    try {
      const index = parseInt(button.dataset.index);
      const row = document.getElementById(`item-row-${index}`);
      if (row) {
        // Remove contribution to cart qty
        const productSelect = row.querySelector(`select[name="item-${index}-product_id"]`);
        const qtyInput = row.querySelector(`input[name="item-${index}-qty"]`);
        const productId = parseInt(productSelect.value);
        const qty = parseInt(qtyInput.value) || 0;
        if (productId && qty > 0) {
          const currentTotal = cartQuantities.get(productId) || 0;
          cartQuantities.set(productId, Math.max(0, currentTotal - qty));
          if (cartQuantities.get(productId) === 0) {
            cartQuantities.delete(productId);
          }
        }
        row.remove();
      }
      updateCartQuantitiesAndStocks();  // Refresh after removal
    } catch (error) {
      console.error('Error removing row:', error);
      showError(null, 'Failed to remove row.', 2000);
    }
  }

  function validateForm() {
    try {
      const rows = document.querySelectorAll('#items-tbody tr');
      const submitBtn = document.getElementById('submit-btn');
      if (!submitBtn) return;

      let hasErrors = false;
      let hasStockIssues = false;

      rows.forEach((row, idx) => {
        const productSelect = row.querySelector(`select[name="item-${idx}-product_id"]`);
        const priceInput = row.querySelector('.price-input');
        const priceError = document.getElementById(`price-error-${idx}`);
        const qtyError = document.getElementById(`qty-error-${idx}`);
        const stockError = document.getElementById(`stock-error-${idx}`);

        if (!productSelect.value) hasErrors = true;
        if (parseFloat(priceInput.value) < parseFloat(priceInput.min) && !priceError.textContent) {
          validatePrice.call(priceInput);
          hasErrors = true;
        }
        if (qtyError && qtyError.textContent) hasErrors = true;
        if (stockError && stockError.textContent && (stockError.textContent.includes('Only') || stockError.textContent.includes('Out') || stockError.textContent.includes('Insufficient') || stockError.textContent.includes('failed'))) hasStockIssues = true;
      });

      const grandTotal = parseFloat(document.getElementById('grand-total-val').textContent.replace('KSh ', '')) || 0;
      const isValid = rows.length > 0 && grandTotal > 0 && !hasErrors && !hasStockIssues;
      submitBtn.disabled = !isValid;
      submitBtn.title = isValid ? '' : 'Please fix all errors and warnings before submitting';
    } catch (error) {
      console.error('Form validation error:', error);
      showError(null, 'Validation error occurred.', 3000);
    }
  }

  // Event delegation for dynamic rows
  document.addEventListener('click', (e) => {
    if (e.target.classList.contains('remove-row')) {
      removeRow(e.target);
    }
  });

  // Debounced global validation on input/change (for any other fields)
  const debouncedValidateForm = debounce(validateForm, DEBOUNCE_DELAY);
  document.addEventListener('input', debouncedValidateForm);
  document.addEventListener('change', debouncedValidateForm);

  // Form submit handler for final check
  document.getElementById('sale-form').addEventListener('submit', (e) => {
    if (document.getElementById('submit-btn').disabled) {
      e.preventDefault();
      showError(null, 'Form has errors. Please review and correct.', 4000);
    }
  });

  // Preload stock on load
  preloadStock();

  // Initial validation
  validateForm();
</script>
{% endblock %}