{% extends "pos/base.html" %}
{% load static %}
{% block title %}New Sale{% endblock %}
{% block page_title %}New Sale{% endblock %}

{% block extra_head %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<style>
  /* Enhanced Color Palette: Teal (#0f766e), Gold (#D4AF37), Dark Teal (#064420) */
  :root {
    --teal: #0f766e;
    --dark-teal: #064420;
    --gold: #D4AF37;
    --gold-dark: #b8962c;
    --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
    --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    --focus-ring: 0 0 0 3px rgb(212 175 55 / 0.5);
  }

  body {
    font-family: 'Inter', ui-sans-serif, system-ui, sans-serif;
  }

  /* Advanced Card Styling */
  .sleek-card {
    background: linear-gradient(145deg, #ffffff, #f8fafc);
    border: 1px solid rgba(0, 0, 0, 0.05);
    border-radius: 20px;
    box-shadow: var(--shadow-md);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
    position: relative;
  }

  .sleek-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--gold), transparent);
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .sleek-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
  }

  .sleek-card:hover::before {
    opacity: 1;
  }

  /* Sleek Form Field Styling (Enforced via forms.py widgets) */
  .sleek-input, .sleek-select, .sleek-textarea {
    @apply w-full px-4 py-3 text-sm font-medium text-gray-900 bg-white border border-gray-200 rounded-xl transition-all duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-1;
    box-shadow: var(--shadow-sm);
  }

  .sleek-input:focus, .sleek-select:focus, .sleek-textarea:focus {
    @apply border-teal-500 ring-teal-500/20;
    box-shadow: var(--focus-ring), var(--shadow-md);
  }

  .sleek-input::placeholder {
    @apply text-gray-400;
  }

  /* Table Container (Guided by Snippet) */
  .table-container {
    @apply bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden;
  }

  .table-container h3 {
    @apply mb-4 text-teal text-lg font-semibold px-6 pt-6;
  }

  /* Table Outline Styling (Simple Bordered Outline) */
  .enhanced-table {
    @apply w-full text-left border-collapse;
    border: 1px solid #e5e7eb;
  }

  .enhanced-table thead th {
    @apply px-6 py-4 text-left text-xs font-bold uppercase tracking-wider bg-teal text-white border border-gray-300;
  }

  /* Distinct Column Widths and Styles */
  .enhanced-table th:nth-child(1) { /* Product Name */
    min-width: 250px;
    max-width: 300px;
  }

  .enhanced-table th:nth-child(2), .enhanced-table th:nth-child(4) { /* Price and Total - Right Aligned */
    @apply text-right;
  }

  .enhanced-table th:nth-child(3) { /* Quantity - Right Aligned */
    min-width: 100px;
    @apply text-right;
  }

  .enhanced-table th:nth-child(5) { /* Actions - Center */
    min-width: 100px;
    @apply text-center;
  }

  .enhanced-table tbody tr {
    @apply transition-all duration-200;
  }

  .enhanced-table tbody td {
    @apply px-6 py-4 text-sm font-medium text-gray-900 align-middle border border-gray-300;
  }

  .enhanced-table tbody td:nth-child(1) { /* Product Name */
    @apply font-semibold text-teal-700;
  }

  .enhanced-table tbody td:nth-child(2), .enhanced-table td:nth-child(3), .enhanced-table td:nth-child(4) {
    @apply text-right font-mono;
  }

  .enhanced-table tbody td:nth-child(4) { /* Line Total */
    @apply text-teal-600 font-bold;
  }

  .enhanced-table tbody td:nth-child(5) { /* Actions */
    @apply text-center;
  }

  /* Enhanced Focus/Hover for Inline-Styled Inputs */
  .table-sleek-input:focus {
    border-color: #0f766e !important;
    box-shadow: 0 0 0 3px rgba(15, 118, 110, 0.1) !important;
  }

  .table-sleek-input:hover {
    border-color: #0891b2 !important;
  }

  /* Remove Button (Styled like Snippet's Sell Button) */
  .remove-item-btn {
    @apply inline-block px-4 py-2 text-sm font-medium text-teal bg-teal-50 rounded border border-teal-200 hover:bg-teal-100 hover:text-teal-700 transition-all duration-200;
  }

  /* Search Panel Enhancements */
  .search-panel {
    @apply bg-gradient-to-b from-teal-50 to-white border border-teal-100 rounded-xl p-6 shadow-lg;
  }

  .search-input {
    @apply sleek-input mb-4;
  }

  .search-result-item {
    @apply flex justify-between items-center p-3 bg-white border border-gray-200 rounded-lg hover:bg-teal-50 hover:border-teal-200 cursor-pointer transition-all duration-200;
  }

  .search-result-item:hover {
    transform: translateX(4px);
  }

  /* Total Display in Footer */
  .table-footer {
    @apply bg-teal-50 border-t border-teal-200;
  }

  .table-footer td {
    @apply py-4 px-6 font-bold border border-gray-300;
  }

  /* Empty State Matching Snippet */
  .empty-state {
    @apply text-center text-gray-500 py-8 border border-gray-300;
  }

  .empty-state td {
    border: 1px solid #e5e7eb;
  }

  /* Button Enhancements */
  .sleek-btn {
    @apply inline-flex items-center justify-center px-6 py-3 text-sm font-semibold rounded-xl transition-all duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2;
    box-shadow: var(--shadow-md);
  }

  .btn-primary {
    @apply bg-gradient-to-r from-teal-600 to-teal-700 text-white hover:from-teal-700 hover:to-teal-800 focus:ring-teal-500;
  }

  /* Notes Textarea */
  .notes-textarea {
    @apply sleek-textarea resize-none;
  }

  /* Grid Responsiveness */
  @media (max-width: 768px) {
    .enhanced-table {
      font-size: 0.875rem;
    }
    .enhanced-table th, .enhanced-table td {
      @apply px-3 py-3;
    }
    .table-container {
      overflow-x: auto;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-7xl">
  <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
    <!-- Main Form Column -->
    <div class="lg:col-span-3">
      <div class="sleek-card p-8 mb-8" role="region" aria-label="Sale creation form">
        <form id="sale-form" method="post" novalidate>
          {% csrf_token %}
          
          <!-- Customer & Branch Details -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="md:col-span-1">
              <label for="{{ form.branch.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">Branch</label>
              {{ form.branch }}
            </div>
            <div class="md:col-span-1">
              <label for="{{ form.customer_phone.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">Phone</label>
              {{ form.customer_phone }}
            </div>
            <div class="md:col-span-1">
              <label for="{{ form.customer_name.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">Name (Optional)</label>
              {{ form.customer_name }}
            </div>
          </div>

          <!-- Items Section (Guided by Snippet with Outline) -->
          <div class="mb-8">
            <div class="table-container">
              <h3 class="mb-4 text-teal">Sale Items</h3>
              <table class="enhanced-table" role="grid" aria-label="Items table">
                <thead>
                  <tr>
                    <th scope="col">Product</th>
                    <th scope="col">Unit Price (KES)</th>
                    <th scope="col">Qty</th>
                    <th scope="col">Line Total (KES)</th>
                    <th scope="col">Action</th>
                  </tr>
                </thead>
                <tbody id="items">
                  <tr class="empty-state" id="empty-row-placeholder">
                    <td colspan="5">Click search to add your first item...</td>
                  </tr>
                </tbody>
                <tfoot class="table-footer">
                  <tr>
                    <td colspan="3" class="text-right">Grand Total:</td>
                    <td id="total" class="text-teal-600 font-bold text-lg" colspan="2">KES 0.00</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>

          <!-- Notes -->
          <div class="mb-8">
            <label for="{{ form.notes.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">Notes (Optional)</label>
            {{ form.notes }}
          </div>

          <!-- Actions (Email Button Removed) -->
          <div class="flex flex-col sm:flex-row gap-4 justify-end items-center pt-6 border-t border-gray-200">
            <button type="submit" class="sleek-btn btn-primary flex-1 sm:flex-none">
              <i data-lucide="check-circle" class="w-4 h-4 mr-2"></i>
              Record Sale
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Quick Actions Sidebar -->
    <div class="lg:col-span-1">
      <div class="search-panel sticky top-8 h-fit" role="region" aria-label="Quick product search">
        <h4 class="text-lg font-bold text-teal-700 mb-6 flex items-center gap-2">
          <i data-lucide="search" class="w-5 h-5"></i>
          Quick Add
        </h4>
        <div class="space-y-4">
          <div>
            <input type="text" id="product-search" class="search-input" placeholder="Search products..." autocomplete="off" aria-label="Search for products to add">
            <div id="search-results" class="mt-2 space-y-1 max-h-60 overflow-y-auto" role="listbox" style="display: none;"></div>
          </div>
          <div class="text-center py-4 text-sm text-gray-500">
            {% if preselected_product %}
              <p>Preselected: {{ preselected_product.name }}</p>
            {% else %}
              <p>Scan or type to add items</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Lucide Icons
  lucide.createIcons();

  // Existing JS functionality retained
  const products = [
    {% for p in products %}
      { id: {{ p.id }}, name: "{{ p.name|escapejs }}", price: {{ p.price }}, min_price: {{ p.min_price }} }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];

  let itemIndex = {% if preselected_product %}1{% else %}0{% endif %};
  const itemsContainer = document.getElementById('items');
  const totalEl = document.getElementById('total');
  const emptyRowPlaceholderHtml = `
    <tr class="empty-state" id="empty-row-placeholder">
      <td colspan="5">Click search to add your first item...</td>
    </tr>
  `;
  let total = 0.0;

  function updatePlaceholder() {
    const currentPlaceholder = document.getElementById('empty-row-placeholder');
    if (itemsContainer.querySelectorAll('.sale-item-row').length === 0) {
      if (!currentPlaceholder) {
        itemsContainer.innerHTML = emptyRowPlaceholderHtml;
      }
    } else {
      if (currentPlaceholder) {
        currentPlaceholder.remove();
      }
    }
  }

  function recalc() {
    total = 0;
    itemsContainer.querySelectorAll('.sale-item-row').forEach(function(row) {
      const price = parseFloat(row.querySelector('.unit-price-input').value || 0);
      const qty = parseInt(row.querySelector('.qty-input').value || 0, 10);
      const line = price * qty;
      row.querySelector('.line-total').innerText = 'KES ' + line.toFixed(2);
      total += line;
    });
    totalEl.innerText = 'KES ' + total.toFixed(2);
    updatePlaceholder();
  }

  function addItem(id, name, price, minprice, qty = 1) {
    const tr = document.createElement('tr');
    tr.className = 'sale-item-row transition-all duration-200';
    tr.setAttribute('role', 'row');
    tr.innerHTML = `
      <td class="font-semibold text-teal-700">${name}</td>
      <td class="text-right">
        <div class="flex flex-col items-end gap-1">
          <div class="flex items-center justify-end gap-1">
            <span class="text-gray-500 text-xs">KES</span>
            <input type="hidden" name="item-${itemIndex}-product_id" value="${id}">
            <input name="item-${itemIndex}-unit_price" class="unit-price-input table-sleek-input" value="${price.toFixed(2)}" min="${minprice}" step="0.01" placeholder="0.00" style="text-align: right; width: 80px; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 4px; font-family: inherit; font-size: 14px; background: white; transition: border-color 0.3s, box-shadow 0.3s; min-width: 60px;">
          </div>
          <span class="text-xs text-gray-500">Min: ${minprice.toFixed(2)}</span>
        </div>
      </td>
      <td class="text-right">
        <input name="item-${itemIndex}-qty" class="qty-input table-sleek-input" type="number" min="1" value="${qty}" step="1" placeholder="1" style="text-align: right; width: 80px; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 4px; font-family: inherit; font-size: 14px; background: white; transition: border-color 0.3s, box-shadow 0.3s; min-width: 60px;">
      </td>
      <td class="line-total text-teal-600 font-bold">KES ${(price * qty).toFixed(2)}</td>
      <td class="text-center">
        <button type="button" class="remove-item-btn" aria-label="Remove item">
          <i data-lucide="trash-2" class="w-4 h-4 mr-1 inline"></i> Remove
        </button>
      </td>
    `;
    itemsContainer.appendChild(tr);

    const unitPriceInput = tr.querySelector('.unit-price-input');
    unitPriceInput.addEventListener('input', function() {
      let val = parseFloat(this.value || 0);
      if (val < minprice) {
        this.value = minprice.toFixed(2);
        val = minprice;
      }
      recalc();
    });

    tr.querySelector('.qty-input').addEventListener('input', function() {
      if (parseInt(this.value) < 1) this.value = 1;
      recalc();
    });

    const removeBtn = tr.querySelector('.remove-item-btn');
    removeBtn.addEventListener('click', () => {
      tr.style.opacity = '0';
      tr.style.transform = 'translateX(-10px)';
      setTimeout(() => {
        tr.remove();
        recalc();
      }, 200);
    });

    itemIndex++;
    recalc();
    updatePlaceholder();
  }

  {% if preselected_product %}
    addItem({{ preselected_product.id }}, "{{ preselected_product.name|escapejs }}", {{ preselected_product.price }}, {{ preselected_product.min_price }});
  {% endif %}

  document.addEventListener('DOMContentLoaded', () => {
    recalc();
    lucide.createIcons();
  });

  // Search functionality (retained and enhanced)
  const searchInput = document.getElementById('product-search');
  const searchResults = document.getElementById('search-results');
  let selectedIndex = -1;
  let debounceTimer;

  searchInput.addEventListener('input', function() {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
      const term = this.value.toLowerCase().trim();
      searchResults.innerHTML = '';
      if (term.length < 1) {
        searchResults.style.display = 'none';
        return;
      }
      const filtered = products.filter(p => p.name.toLowerCase().includes(term));
      if (filtered.length === 0) {
        searchResults.innerHTML = '<div class="p-3 text-gray-500 text-center">No products found</div>';
        searchResults.style.display = 'block';
        return;
      }
      filtered.forEach((p, index) => {
        const div = document.createElement('div');
        div.className = 'search-result-item';
        div.setAttribute('role', 'option');
        div.setAttribute('aria-selected', index === 0 ? 'true' : 'false');
        div.innerHTML = `
          <div>
            <div class="font-semibold text-teal-700">${p.name}</div>
            <div class="text-xs text-gray-500">KES ${p.price.toFixed(2)}</div>
          </div>
          <i data-lucide="plus" class="w-4 h-4 text-teal-500"></i>
        `;
        div.addEventListener('click', () => {
          addItem(p.id, p.name, p.price, p.min_price);
          this.value = '';
          searchResults.style.display = 'none';
          selectedIndex = -1;
        });
        searchResults.appendChild(div);
      });
      searchResults.style.display = 'block';
      selectedIndex = -1;
    }, 250);
  });

  // Keyboard navigation (retained)
  searchInput.addEventListener('keydown', function(e) {
    const items = searchResults.querySelectorAll('.search-result-item');
    if (items.length === 0) return;

    if (e.key === 'ArrowDown') {
      e.preventDefault();
      selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
      updateSelection(items);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      selectedIndex = Math.max(selectedIndex - 1, 0);
      updateSelection(items);
    } else if (e.key === 'Enter' && selectedIndex >= 0) {
      e.preventDefault();
      items[selectedIndex].click();
    } else if (e.key === 'Escape') {
      searchResults.style.display = 'none';
      this.value = '';
      selectedIndex = -1;
    }
  });

  function updateSelection(items) {
    items.forEach((item, index) => {
      const isSelected = index === selectedIndex;
      item.setAttribute('aria-selected', isSelected);
      if (isSelected) {
        item.classList.add('bg-teal-50', 'border-teal-200');
        item.focus();
        item.scrollIntoView({ block: 'nearest' });
      } else {
        item.classList.remove('bg-teal-50', 'border-teal-200');
      }
    });
  }

  // Close search on outside click
  document.addEventListener('click', function(e) {
    if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
      searchResults.style.display = 'none';
      selectedIndex = -1;
    }
  });
</script>
{% endblock %}