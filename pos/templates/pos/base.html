{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Azaria Pharmacy - {% block title %}{% endblock %}</title>

  {# --- FAVICON VIA CDN LINK --- #}
  <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/64/7227/7227090.png" /> 
  {# NOTE: Pill icon for pharmacy favicon #}

  <script src="https://cdn.tailwindcss.com"></script>

  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    :root {
      --darkgreen: #064420;
      --gold: #D4AF37;
      --gold-dark: #b8962c;
      --panel-bg: #ffffff;
      --muted: #6b7280;
    }

    /* Basic page */
    body {
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: #f3f4f6;
      color: #111827;
      min-height: 100vh; /* Ensure full viewport height */
    }

    /* --------------------------------- */
    /* --- ADVANCED SIDEBAR STYLING --- */
    /* --------------------------------- */
    .sidebar-panel {
      background: linear-gradient(180deg, var(--darkgreen), #0b3a2b);
      color: var(--gold);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    /* Nav link base */
    .nav-link {
      display: flex;
      align-items: center;
      gap: .75rem;
      padding: .6rem .75rem;
      border-radius: .5rem;
      color: var(--gold);
      text-decoration: none;
      font-weight: 500;
      transition: all 0.2s ease-in-out;
      position: relative;
      overflow: hidden;
    }
    
    /* Hover effect: Subtle background shift */
    .nav-link:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateX(4px);
    }

    /* Active link: Gold Gradient with Border/Shadow */
    .nav-link.active {
      background: linear-gradient(90deg, var(--gold) 0%, rgba(255, 255, 255, 0.9) 100%);
      color: var(--darkgreen);
      font-weight: 700;
      box-shadow: 0 4px 15px rgba(212, 175, 55, 0.4);
      border-left: 4px solid var(--gold);
      transform: none;
    }
    /* --------------------------------- */
    
    /* Default Primary Button (Login/Standard) */
    .btn-primary {
      background: var(--gold);
      color: var(--darkgreen);
      padding: .45rem .85rem;
      border-radius: .5rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: .5rem;
      transition: background 0.2s ease;
    }
    .btn-primary:hover {
      background: var(--gold-dark);
    }
    
    /* Enhanced Logout Button (Outline/Danger) */
    .btn-logout {
      background: transparent;
      border: 1px solid #d1d5db; /* Lighter gray border */
      color: #374151;
      padding: .45rem .85rem;
      border-radius: .5rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: .5rem;
      transition: all 0.2s ease-in-out;
    }
    .btn-logout:hover {
      background: #ef4444; /* Red danger background on hover */
      border-color: #ef4444;
      color: white;
      box-shadow: 0 4px 10px rgba(239, 68, 68, 0.4);
    }

    /* Flash Message Styling */
    .flash {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      align-items: flex-start;
      padding: .85rem 1rem;
      border-radius: .5rem;
      background: var(--gold);
      color: var(--darkgreen);
      margin-bottom: .75rem;
      box-shadow: 0 6px 18px rgba(15,23,42,.06);
    }
    .flash .close {
      background: transparent;
      border: 0;
      font-size: 1rem;
      cursor: pointer;
      color: var(--darkgreen);
    }

    .fade-out {
      transition: opacity .35s ease, transform .35s ease;
      opacity: 0;
      transform: translateY(-6px);
    }

    /* Sidebar footer */
    .sidebar-footer a {
      color: var(--gold);
      text-decoration: none;
    }

    /* Mobile backdrop */
    .backdrop {
      background: rgba(0,0,0,0.45);
    }

    /* Ensure main content doesn't overflow */
    .main-content {
      width: 100%;
      min-width: 0; 
    }
    
    /* Smooth Title Transition for main content */
    .page-title-group > * {
        transition: opacity 0.3s ease-in-out;
    }

    /* Modal Animations */
    #notifications-modal {
      animation: fadeIn 0.3s ease-out;
    }

    #notifications-modal.hidden {
      animation: fadeOut 0.2s ease-in forwards;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @keyframes fadeOut {
      from {
        opacity: 1;
      }
      to {
        opacity: 0;
      }
    }

    .modal-content {
      animation: slideInLeft 0.3s ease-out;
    }

    @keyframes slideInLeft {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    #notifications-list li {
      transition: all 0.2s ease-in-out;
    }

    #notifications-list li:hover {
      transform: translateX(4px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    /* Notification item styles */
    .notification-unread {
      background-color: #dbeafe;
      border-left: 4px solid #3b82f6;
    }

    .notification-read {
      background-color: #f3f4f6;
    }

    .mark-btn {
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.75rem;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .mark-read {
      background-color: #10b981;
      color: white;
    }

    .mark-unread {
      background-color: #ef4444;
      color: white;
    }
  </style>
</head>
<body class="min-h-screen">
  <div id="mobile-backdrop" class="fixed inset-0 z-30 hidden lg:hidden backdrop"></div>

  <div class="flex min-h-screen">
    {# SIDEBAR - transform-based so we can toggle on mobile #}
    {% if request.user.is_authenticated %}
    <aside id="sidebar"
           class="sidebar-panel fixed inset-y-0 left-0 z-40 w-64 transform -translate-x-full lg:translate-x-0 transition-transform duration-200 ease-in-out flex flex-col h-screen text-base"
           aria-hidden="true">
      <div class="p-5">
        <div class="flex items-center gap-3 mb-5">
          {# ICON IN CUBED (SQUARE) BACKGROUND - using <figure> for semantics #}
          <figure class="w-11 h-11 rounded-lg bg-white/8 flex items-center justify-center text-lg" role="img" aria-label="Azaria Pharmacy Logo">
            <i data-lucide="stethoscope" class="w-6 h-6"></i>
          </figure>
          <div>
            <div class="text-lg font-semibold">Azaria Pharmacy</div>
          </div>
        </div>

        <nav class="space-y-1 mt-2">
          <a href="{% url 'pos:dashboard' %}" class="nav-link {% if request.resolver_match and request.resolver_match.url_name == 'dashboard' %}active{% endif %}">
            <i data-lucide="home" class="w-4 h-4"></i>
            <span>Dashboard</span>
          </a>
          <a href="{% url 'pos:sale_create' %}" class="nav-link {% if request.resolver_match and request.resolver_match.url_name == 'sale_create' %}active{% endif %}">
            <i data-lucide="shopping-cart" class="w-4 h-4"></i>
            <span>New Sale</span>
          </a>
          <a href="{% url 'pos:product_list' %}" class="nav-link {% if request.resolver_match and request.resolver_match.url_name == 'product_list' %}active{% endif %}">
            <i data-lucide="boxes" class="w-4 h-4"></i>
            <span>Products</span>
          </a>
          <a href="{% url 'pos:reports' %}" class="nav-link {% if request.resolver_match and request.resolver_match.url_name == 'reports' %}active{% endif %}">
            <i data-lucide="bar-chart-3" class="w-4 h-4"></i>
            <span>Reports</span>
          </a>
        </nav>
      </div>
      <div class="mt-auto p-4 border-t border-white/6 text-center sidebar-footer">
        &copy; {% now "Y" %} - Built by
        <a href="https://amigohub.africa" target="_blank" rel="noopener">Amigo Hub</a>
      </div>
    </aside>
    {% endif %}

    <div class="flex-1 main-content lg:ml-64">
      <header class="bg-white border-b sticky top-0 z-20"> {# Added sticky top for persistent header #}
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex items-center justify-between h-16">
            <div class="flex items-center gap-3">
              {# Hamburger only visible on small screens to toggle sidebar #}
              {% if request.user.is_authenticated %}
                <button id="sidebarToggle" class="lg:hidden inline-flex items-center justify-center p-2 rounded-md text-gray-600 hover:bg-gray-100" aria-label="Open sidebar">
                  <i data-lucide="menu" class="w-5 h-5"></i>
                </button>
              {% endif %}
              {# page title shown only when logged in #}
              <div class="page-title-group">
                {% if request.user.is_authenticated %}
                  <h1 class="text-lg font-semibold">{% block page_title %}Dashboard{% endblock %}</h1>
                  <p class="text-sm text-gray-500">{% now "l, F d, Y" %} | {% now "H:i" %} HRS</p>
                {% endif %}
              </div>
            </div>
            <div class="flex items-center gap-3">
              {# if on login/signup view, do not show top-right buttons #}
              {% if request.resolver_match and request.resolver_match.url_name not in 'login signup' %}
                {% if request.user.is_authenticated %}
                  <div class="flex items-center gap-3">
                    <div class="relative" id="bell-container">
                      <button id="notifications-bell" class="p-2 rounded-full hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gold" aria-label="Notifications">
                        <i data-lucide="bell-ring" class="w-5 h-5 text-gray-600"></i>
                        <span id="unread-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full min-w-[18px] h-5 flex items-center justify-center" style="display: none;">0</span>
                      </button>
                    </div>
                    <span class="text-gray-700 font-medium hidden sm:inline">Salutations, {{ request.user.get_username }}</span>
                    <form action="{% url 'pos:logout' %}" method="post" class="inline">
                      {% csrf_token %}
                      <button type="submit" class="btn-logout focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                        <i data-lucide="log-out" class="w-4 h-4"></i>
                        <span class="hidden sm:inline">Logout</span>
                      </button>
                    </form>
                  </div>
                {% else %}
                  <a href="{% url 'pos:login' %}" class="btn-primary">
                    <i data-lucide="log-in" class="w-4 h-4"></i>
                    <span>Login</span>
                  </a>
                {% endif %}
              {% endif %}
            </div>
          </div>
        </div>
      </header>

      <main class="py-6 min-h-[calc(100vh-4rem)]">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div id="flash-container">
            {% if messages %}
              {% for msg in messages %}
                <div class="flash" data-timeout="10000" role="alert">
                  <div>
                    <div class="font-semibold">{{ msg.tags|capfirst }}</div>
                    <div class="text-sm text-gray-900">{{ msg }}</div>
                  </div>
                  <div>
                    <button class="close" aria-label="Dismiss">âœ•</button>
                  </div>
                </div>
              {% endfor %}
            {% endif %}
          </div>
          <div>
            {% block content %}{% endblock %}
          </div>
        </div>
      </main>
    </div>
  </div>

  {# Notifications Modal #}
  <div id="notifications-modal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex min-h-screen items-end justify-center px-4 pt-4 pb-20 text-center sm:block sm:p-0">
      <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
      <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
      <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full modal-content">
        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
          <div class="sm:flex sm:items-start">
            <div class="mt-3 text-center sm:ml-4 sm:text-left">
              <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                Notifications
              </h3>
              <div class="mt-2">
                <ul id="notifications-list" class="space-y-2 max-h-96 overflow-y-auto">
                </ul>
              </div>
            </div>
          </div>
        </div>
        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
          <button id="close-notifications" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-gold text-base font-medium text-darkgreen hover:bg-gold-dark sm:ml-3 sm:w-auto sm:text-sm">
            Close
          </button>
        </div>
      </div>
    </div>
  </div>

  {# Notification Sound #}
  <audio id="notifySound" preload="auto">
    <source src="https://freesound.org/data/previews/571/571513_12600480-lq.mp3" type="audio/mpeg">
  </audio>

  <script>
    // Render lucide icons
    if (typeof lucide !== 'undefined' && lucide.createIcons) {
      lucide.createIcons();
    } else {
      window.addEventListener('load', () => { if (window.lucide) lucide.createIcons(); });
    }

    // Sidebar toggle logic (mobile)
    (function() {
      const sidebar = document.getElementById('sidebar');
      const toggleBtn = document.getElementById('sidebarToggle');
      const backdrop = document.getElementById('mobile-backdrop');

      function openSidebar() {
        if (!sidebar) return;
        sidebar.classList.remove('-translate-x-full');
        sidebar.setAttribute('aria-hidden', 'false');
        if (backdrop) backdrop.classList.remove('hidden');
      }
      function closeSidebar() {
        if (!sidebar) return;
        sidebar.classList.add('-translate-x-full');
        sidebar.setAttribute('aria-hidden', 'true');
        if (backdrop) backdrop.classList.add('hidden');
      }

      if (toggleBtn) {
        toggleBtn.addEventListener('click', () => {
          if (!sidebar) return;
          if (sidebar.classList.contains('-translate-x-full')) openSidebar();
          else closeSidebar();
        });
      }

      if (backdrop) {
        backdrop.addEventListener('click', closeSidebar);
      }

      // Close sidebar when resizing to large screens (cleanup)
      window.addEventListener('resize', () => {
        if (window.innerWidth >= 1024 && sidebar) {
          sidebar.classList.remove('-translate-x-full');
          sidebar.setAttribute('aria-hidden', 'false');
          if (backdrop) backdrop.classList.add('hidden');
        }
      });
    })();

    // Flash messages auto-hide + manual close
    (function() {
      const flashContainer = document.getElementById('flash-container');
      if (!flashContainer) return;
      
      flashContainer.querySelectorAll('.flash').forEach((el) => {
        const timeout = parseInt(el.dataset.timeout || '10000', 10);
        let timer = setTimeout(() => {
          el.classList.add('fade-out');
          setTimeout(() => el.remove(), 450);
        }, timeout);
        
        const btn = el.querySelector('.close');
        if (btn) {
          btn.addEventListener('click', () => {
            clearTimeout(timer);
            el.classList.add('fade-out');
            setTimeout(() => el.remove(), 260);
          });
        }
      });
    })();

    // Notifications functionality
    (function() {
      if (!{% if user.is_superuser %}true{% else %}false{% endif %}) return; // Only for superuser

      let unreadIds = JSON.parse(localStorage.getItem('readNotifications') || '[]');
      let allNotifications = [];

      function updateBadge(count) {
        const badge = document.getElementById('unread-badge');
        if (count > 0) {
          badge.textContent = count;
          badge.style.display = 'flex';
        } else {
          badge.style.display = 'none';
        }
      }

      function toggleRead(id) {
        const index = unreadIds.indexOf(id);
        if (index > -1) {
          unreadIds.splice(index, 1);
        } else {
          unreadIds.push(id);
        }
        localStorage.setItem('readNotifications', JSON.stringify(unreadIds));
        populateList();
        updateBadge(allNotifications.filter(n => !unreadIds.includes(n.id)).length);
      }

      function populateList() {
        const list = document.getElementById('notifications-list');
        const unreadCount = allNotifications.filter(n => !unreadIds.includes(n.id)).length;
        list.innerHTML = allNotifications.map(n => {
          const isRead = unreadIds.includes(n.id);
          return `
            <li class="p-3 border border-gray-200 rounded-lg shadow-sm ${isRead ? 'notification-read' : 'notification-unread'}">
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <p class="text-sm font-medium text-gray-900">${n.message}</p>
                  <p class="text-xs text-gray-500 mt-1">${new Date(n.created).toLocaleDateString()}</p>
                </div>
                <button class="mark-btn ${isRead ? 'mark-unread' : 'mark-read'} ml-2" onclick="toggleRead(${n.id})">
                  ${isRead ? 'Unread' : 'Read'}
                </button>
              </div>
            </li>
          `;
        }).join('');
      }

      async function fetchNotifications() {
        try {
          const response = await fetch('{% url "pos:get_notifications" %}');
          const data = await response.json();
          allNotifications = data.notifications;
          const unread = allNotifications.filter(n => !unreadIds.includes(n.id));
          updateBadge(unread.length);

          // Play sound if unread on initial load
          if (unread.length > 0 && !window.notificationSoundPlayed) {
            const audio = document.getElementById('notifySound');
            audio.play().catch(e => console.log('Sound play failed:', e));
            window.notificationSoundPlayed = true;
          }

          // Populate list only when modal open
          if (!document.getElementById('notifications-modal').classList.contains('hidden')) {
            populateList();
          }
        } catch (e) {
          console.error('Error fetching notifications:', e);
        }
      }

      // Expose toggleRead to global scope for onclick
      window.toggleRead = toggleRead;

      document.getElementById('notifications-bell').addEventListener('click', () => {
        document.getElementById('notifications-modal').classList.remove('hidden');
        populateList();
      });

      document.getElementById('close-notifications').addEventListener('click', () => {
        document.getElementById('notifications-modal').classList.add('hidden');
      });

      document.querySelector('#notifications-modal .fixed.inset-0').addEventListener('click', (e) => {
        if (e.target.classList.contains('fixed')) {
          document.getElementById('notifications-modal').classList.add('hidden');
        }
      });

      // Poll every 30 seconds
      setInterval(fetchNotifications, 30000);
      fetchNotifications(); // Initial load
    })();
  </script>
</body>
</html>