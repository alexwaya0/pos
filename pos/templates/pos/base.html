{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Azariah Pharmacy - {% block title %}{% endblock %}</title>

  {# --- FAVICON VIA CDN LINK --- #}
  <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/8279/8279117.png" /> 
  {# NOTE: Hospital icon in teal for pharmacy favicon #}

  <script src="https://cdn.tailwindcss.com"></script>

  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    :root {
      --darkgreen: #064420;
      --gold: #D4AF37;
      --gold-dark: #D4AF37; /* Adjusted to match gold for better visibility, removing tan-like dullness */
      --panel-bg: #ffffff;
      --muted: #6b7280;
      --glass-bg: rgba(255, 255, 255, 0.25);
      --glass-border: rgba(255, 255, 255, 0.18);
      --neon-glow: 0 0 10px rgba(212, 175, 55, 0.5);
    }

    /* Basic page */
    body {
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: #f3f4f6;
      color: #111827;
      min-height: 100vh; /* Ensure full viewport height */
    }

    /* Seamless Page Transition Styles */
    .page-wrapper {
      position: relative;
      overflow: hidden;
    }

    .page-content {
      animation: fadeSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
      opacity: 0;
      transform: translateY(10px);
    }

    @keyframes fadeSlideIn {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Preload animation trigger */
    body.loaded .page-content {
      animation-play-state: running;
    }

    /* --------------------------------- */
    /* --- ADVANCED SIDEBAR STYLING --- */
    /* --------------------------------- */
    .sidebar-panel {
      background: linear-gradient(180deg, var(--darkgreen), #0b3a2b);
      color: var(--gold);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    /* Enhanced Nav link base */
    .nav-link {
      display: flex;
      align-items: center;
      gap: .75rem;
      padding: .75rem 1rem; /* Slightly more padding for better touch targets */
      border-radius: .5rem;
      color: var(--gold);
      text-decoration: none;
      font-weight: 500;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      margin: 0.125rem 0; /* Small margin for separation */
    }
    
    /* Hover effect: Subtle background shift with ripple */
    .nav-link:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateX(4px);
      box-shadow: var(--neon-glow);
    }

    .nav-link::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    .nav-link:active::before {
      width: 300px;
      height: 300px;
    }

    /* Active link: Enhanced Gold Gradient with Border/Shadow and Icon Glow */
    .nav-link.active {
      background: linear-gradient(90deg, var(--gold) 0%, rgba(255, 255, 255, 0.9) 100%);
      color: var(--darkgreen);
      font-weight: 700;
      box-shadow: 0 4px 15px rgba(212, 175, 55, 0.4);
      border-left: 4px solid var(--gold);
      transform: none;
    }

    .nav-link.active i {
      filter: drop-shadow(0 0 4px rgba(212, 175, 55, 0.8));
      transform: scale(1.1);
    }

    .nav-link i {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .nav-link:hover i {
      transform: scale(1.1) rotate(5deg);
    }
    /* --------------------------------- */
    
    /* Default Primary Button (Login/Standard) */
    .btn-primary {
      background: var(--gold);
      color: var(--darkgreen);
      padding: .45rem .85rem;
      border-radius: .5rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: .5rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 14px 0 rgba(212, 175, 55, 0.39);
    }
    .btn-primary:hover {
      background: var(--gold-dark);
      transform: translateY(-1px);
      box-shadow: 0 8px 25px 0 rgba(212, 175, 55, 0.4);
    }
    
    /* Enhanced Engraved Logout Button */
    .btn-logout {
      background: linear-gradient(145deg, #f8f9fa, #e9ecef); /* Subtle bevel for engraved look */
      border: 1px solid #dee2e6;
      color: #495057;
      padding: .4rem .8rem;
      border-radius: .4rem;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: .4rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06), 0 1px 2px rgba(0, 0, 0, 0.1); /* Inset shadow for engraving */
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 0.875rem;
    }
    .btn-logout:hover {
      background: linear-gradient(145deg, #e9ecef, #dee2e6);
      border-color: #adb5bd;
      color: #212529;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1), 0 2px 4px rgba(0, 0, 0, 0.15), var(--neon-glow); /* Deeper inset on hover */
      transform: translateY(-1px);
    }
    .btn-logout::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
      transition: left 0.6s;
    }
    .btn-logout:hover::before {
      left: 100%;
    }
    .btn-logout i {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .btn-logout:hover i {
      transform: rotate(180deg) scale(1.1);
    }

    /* Accessibility: Enhanced focus styles for all interactive elements */
    button:focus-visible,
    a:focus-visible,
    input:focus-visible,
    select:focus-visible,
    textarea:focus-visible {
      outline: 2px solid var(--gold);
      outline-offset: 2px;
      border-radius: 0.375rem;
    }

    /* Flash Message Styling */
    .flash {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      align-items: flex-start;
      padding: .85rem 1rem;
      border-radius: .5rem;
      background: linear-gradient(135deg, var(--gold), var(--gold-dark));
      color: var(--darkgreen);
      margin-bottom: .75rem;
      box-shadow: 0 6px 18px rgba(212, 175, 55, 0.3);
    }
    .flash .close {
      background: transparent;
      border: 0;
      font-size: 1rem;
      cursor: pointer;
      color: var(--darkgreen);
      transition: opacity 0.2s;
    }
    .flash .close:hover {
      opacity: 0.7;
    }

    .fade-out {
      transition: opacity .35s ease, transform .35s ease;
      opacity: 0;
      transform: translateY(-6px);
    }

    /* Sidebar footer */
    .sidebar-footer a {
      color: var(--gold);
      text-decoration: none;
      transition: color 0.2s;
    }
    .sidebar-footer a:hover {
      color: var(--gold-dark);
    }

    /* Mobile backdrop */
    .backdrop {
      background: rgba(0,0,0,0.45);
    }

    /* Ensure main content doesn't overflow */
    .main-content {
      width: 100%;
      min-width: 0; 
    }
    
    /* Smooth Title Transition for main content */
    .page-title-group > * {
        transition: opacity 0.3s ease-in-out;
    }

    /* Enhanced Header/Nav Bar */
    header {
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      border-bottom: 1px solid rgba(212, 175, 55, 0.1);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    /* Enhanced Notification Dropdown Styles - More Futuristic Glassmorphism */
    #notifications-dropdown {
      transform-origin: top right;
      backdrop-filter: blur(20px);
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      max-width: 90vw;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(255, 255, 255, 0.05);
    }

    #notifications-dropdown::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--gold), transparent);
    }

    #notifications-dropdown:not(.hidden) {
      animation: slideDown 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: scaleY(0.95) translateY(-10px) rotateX(5deg);
      }
      to {
        opacity: 1;
        transform: scaleY(1) translateY(0) rotateX(0deg);
      }
    }

    /* Enhanced Header */
    #notifications-dropdown .border-b {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-color: var(--glass-border);
    }

    #notifications-heading {
      color: var(--gold);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    #mark-all-read {
      background: rgba(212, 175, 55, 0.2);
      padding: 0.25rem 0.75rem;
      border-radius: 0.375rem;
      border: 1px solid rgba(212, 175, 55, 0.3);
      transition: all 0.3s ease;
    }

    #mark-all-read:hover {
      background: rgba(212, 175, 55, 0.3);
      box-shadow: var(--neon-glow);
      transform: translateX(4px);
    }

    /* Enhanced List Items */
    #notifications-list {
      background: rgba(255, 255, 255, 0.05);
    }

    #notifications-list li {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border-radius: 0.5rem;
      margin: 0.25rem;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.05);
      position: relative;
      overflow: hidden;
    }

    #notifications-list li::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: linear-gradient(to bottom, var(--gold), var(--gold-dark));
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    #notifications-list li:hover::before {
      opacity: 1;
    }

    #notifications-list li:hover {
      transform: scale(1.02) translateX(2px);
      box-shadow: var(--neon-glow), 0 4px 12px rgba(0, 0, 0, 0.1);
      background: rgba(255, 255, 255, 0.2);
    }

    /* Notification item styles - Enhanced */
    .notification-unread {
      background-color: rgba(219, 234, 254, 0.3);
      border-left: 4px solid #3b82f6;
      box-shadow: inset 0 0 0 1px rgba(59, 130, 246, 0.2);
    }

    .notification-read {
      background-color: rgba(243, 244, 246, 0.3);
    }

    .relative-time {
      font-size: 0.75rem;
      color: #9ca3af;
      text-shadow: 0 1px 1px rgba(0, 0, 0, 0.05);
    }

    /* Enhanced Mark Buttons */
    .mark-btn {
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      border: none;
      font-weight: 600;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }

    .mark-read {
      background-color: #10b981;
      color: white;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }

    .mark-unread {
      background-color: #ef4444;
      color: white;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
    }

    .mark-btn:hover {
      transform: scale(1.05) translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    /* Enhanced Footer */
    #notifications-dropdown .bg-gray-50 {
      background: rgba(255, 255, 255, 0.1) !important;
      border-color: var(--glass-border);
    }

    #notifications-dropdown a[href="#"] {
      color: var(--gold);
      text-decoration: none;
      padding: 0.5rem;
      border-radius: 0.375rem;
      transition: all 0.3s ease;
      display: block;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    #notifications-dropdown a[href="#"]:hover {
      background: rgba(212, 175, 55, 0.2);
      box-shadow: var(--neon-glow);
      transform: translateY(-1px);
    }

    /* Badge pulse if unread */
    #unread-badge {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      box-shadow: var(--neon-glow);
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 1;
        transform: scale(1);
      }
      50% {
        opacity: .5;
        transform: scale(1.1);
      }
    }

    /* Futuristic bell glow when unread */
    #bell-container:has(#unread-badge[style*="display: flex"]) #notifications-bell {
      box-shadow: var(--neon-glow);
      animation: glow 1.5s ease-in-out infinite alternate;
    }

    @keyframes glow {
      from { box-shadow: var(--neon-glow); }
      to { box-shadow: 0 0 20px rgba(212, 175, 55, 0.8); }
    }
  </style>
</head>
<body class="min-h-screen">
  <div id="mobile-backdrop" class="fixed inset-0 z-30 hidden lg:hidden backdrop"></div>

  <div class="flex min-h-screen page-wrapper">
    {# SIDEBAR - transform-based so we can toggle on mobile #}
    {% if request.user.is_authenticated %}
    <aside id="sidebar"
           class="sidebar-panel fixed inset-y-0 left-0 z-40 w-64 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-out flex flex-col h-screen text-base"
           aria-hidden="true">
      <div class="p-5">
        <div class="flex items-center gap-3 mb-5">
          {# ICON IN CUBED (SQUARE) BACKGROUND - using <figure> for semantics #}
          <figure class="w-11 h-11 rounded-lg bg-white/8 flex items-center justify-center text-lg backdrop-filter: blur(10px)" role="img" aria-label="Azariah Pharmacy Logo">
            <i data-lucide="stethoscope" class="w-6 h-6"></i>
          </figure>
          <div>
            <div class="text-lg font-semibold">Azariah Pharmacy</div>
          </div>
        </div>

        <nav class="space-y-1 mt-2">
          <a href="{% url 'pos:dashboard' %}" class="nav-link {% if request.resolver_match and request.resolver_match.url_name == 'dashboard' %}active{% endif %}" aria-label="Go to Dashboard">
            <i data-lucide="home" class="w-4 h-4"></i>
            <span>Dashboard</span>
          </a>
          <a href="{% url 'pos:sale_create' %}" class="nav-link {% if request.resolver_match and request.resolver_match.url_name == 'sale_create' %}active{% endif %}" aria-label="Create New Sale">
            <i data-lucide="shopping-cart" class="w-4 h-4"></i>
            <span>New Sale</span>
          </a>
          <a href="{% url 'pos:product_list' %}" class="nav-link {% if request.resolver_match and request.resolver_match.url_name == 'product_list' %}active{% endif %}" aria-label="View Products">
            <i data-lucide="boxes" class="w-4 h-4"></i>
            <span>Products</span>
          </a>
          {% if user.is_superuser %}
          <a href="{% url 'pos:reports' %}" class="nav-link {% if request.resolver_match and request.resolver_match.url_name == 'reports' %}active{% endif %}" aria-label="View Reports">
            <i data-lucide="bar-chart-3" class="w-4 h-4"></i>
            <span>Reports</span>
          </a>
          {% else %}
          {% for group in user.groups.all %}
          {% if group.name == 'Manager' %}
          <a href="{% url 'pos:reports' %}" class="nav-link {% if request.resolver_match and request.resolver_match.url_name == 'reports' %}active{% endif %}" aria-label="View Reports">
            <i data-lucide="bar-chart-3" class="w-4 h-4"></i>
            <span>Reports</span>
          </a>
          {% endif %}
          {% endfor %}
          {% endif %}
        </nav>
      </div>

      <div class="mt-auto p-4 border-t border-white/6 text-center sidebar-footer">
        &copy; {% now "Y" %} - Built by
        <a href="https://amigohub.africa" target="_blank" rel="noopener" aria-label="Visit Amigo Hub website">Amigo Hub</a>
      </div>
    </aside>
    {% endif %}

    <div class="flex-1 main-content lg:ml-64">
      <header class="bg-white border-b sticky top-0 z-20"> {# Added sticky top for persistent header #}
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex items-center justify-between h-16">
            <div class="flex items-center gap-3">
              {# Hamburger only visible on small screens to toggle sidebar #}
              {% if request.user.is_authenticated %}
                <button id="sidebarToggle" class="lg:hidden inline-flex items-center justify-center p-2 rounded-md text-gray-600 hover:bg-gray-100 transition-all duration-200" aria-label="Toggle navigation menu" aria-expanded="false">
                  <i data-lucide="menu" class="w-5 h-5"></i>
                </button>
              {% endif %}
              {# page title shown only when logged in #}
              <div class="page-title-group">
                {% if request.user.is_authenticated %}
                  <h1 class="text-lg font-semibold">{% block page_title %}Dashboard{% endblock %}</h1>
                  <p class="text-sm text-gray-500">{% now "l, F d, Y" %} | {% now "H:i" %} HRS</p>
                {% endif %}
              </div>
            </div>
            <div class="flex items-center gap-3">
              {# if on login/signup view, do not show top-right buttons #}
              {% if request.resolver_match and request.resolver_match.url_name not in 'login signup' %}
                {% if request.user.is_authenticated %}
                  <div class="flex items-center gap-3">
                    {% if user.is_superuser %}
                    <div class="relative" id="bell-container">
                      <button id="notifications-bell" class="p-2 rounded-full bg-gray-100 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gold transition-all duration-200" aria-label="View notifications" aria-haspopup="true" aria-expanded="false">
                        <i data-lucide="bell-ring" class="w-5 h-5 text-gray-600"></i>
                        <span id="unread-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full min-w-[18px] h-5 flex items-center justify-center" style="display: none;">0</span>
                      </button>
                      {# Notifications Dropdown #}
                      <div id="notifications-dropdown" class="hidden absolute top-full right-0 mt-2 w-80 bg-white rounded-lg shadow-xl z-50 overflow-hidden border border-gray-200 sm:w-80 md:w-96 md:right-auto md:left-1/2 md:-translate-x-1/2 max-w-xs sm:max-w-sm mx-2 lg:max-w-md" role="menu" aria-labelledby="notifications-bell">
                        <div class="p-4 border-b border-gray-200">
                          <div class="flex justify-between items-center">
                            <h3 class="text-lg font-medium text-gray-900" id="notifications-heading">Notifications</h3>
                            <button id="mark-all-read" class="text-sm text-blue-600 hover:text-blue-800 font-medium transition-colors duration-200" aria-label="Mark all notifications as read">Mark all as read</button>
                          </div>
                        </div>
                        <ul id="notifications-list" class="max-h-96 overflow-y-auto divide-y divide-gray-200" role="menu" aria-labelledby="notifications-heading">
                        </ul>
                        <div class="p-4 border-t border-gray-200 bg-gray-50">
                          <a href="#" class="text-sm text-blue-600 hover:text-blue-800 font-medium block text-center transition-colors duration-200" aria-label="View all notifications">View all notifications</a>
                        </div>
                      </div>
                    </div>
                    {% endif %}
                    <span class="text-gray-700 font-medium hidden sm:inline" aria-live="polite">Salutations, {{ user.first_name|default:user.get_username }}</span>
                    <form action="{% url 'pos:logout' %}" method="post" class="inline" aria-label="Logout form">
                      {% csrf_token %}
                      <button type="submit" class="btn-logout focus:outline-none focus:ring-2 focus:ring-gold focus:ring-offset-2" aria-label="Log out of the application">
                        <i data-lucide="log-out" class="w-4 h-4"></i>
                        <span class="hidden sm:inline">Logout</span>
                      </button>
                    </form>
                  </div>
                {% else %}
                  <a href="{% url 'pos:login' %}" class="btn-primary" aria-label="Log in to the application">
                    <i data-lucide="log-in" class="w-4 h-4"></i>
                    <span>Login</span>
                  </a>
                {% endif %}
              {% endif %}
            </div>
          </div>
        </div>
      </header>

      <main class="py-6 min-h-[calc(100vh-4rem)]">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div id="flash-container" role="status" aria-live="polite">
            {% if messages %}
              {% for msg in messages %}
                <div class="flash" data-timeout="10000" role="alert" aria-label="{{ msg.tags|capfirst }} message">
                  <div>
                    <div class="font-semibold">{{ msg.tags|capfirst }}</div>
                    <div class="text-sm text-gray-900">{{ msg }}</div>
                  </div>
                  <div>
                    <button class="close" aria-label="Dismiss this message">âœ•</button>
                  </div>
                </div>
              {% endfor %}
            {% endif %}
          </div>
          <div class="page-content">
            {% block content %}{% endblock %}
          </div>
        </div>
      </main>
    </div>
  </div>

  {# Notification Sound #}
  <audio id="notifySound" preload="auto">
    <source src="https://freesound.org/data/previews/571/571513_12600480-lq.mp3" type="audio/mpeg">
  </audio>

  <script>
    // Trigger seamless load animation
    document.addEventListener('DOMContentLoaded', () => {
      document.body.classList.add('loaded');
    });

    // Render lucide icons
    if (typeof lucide !== 'undefined' && lucide.createIcons) {
      lucide.createIcons();
    } else {
      window.addEventListener('load', () => { if (window.lucide) lucide.createIcons(); });
    }

    // Sidebar toggle logic (mobile)
    (function() {
      const sidebar = document.getElementById('sidebar');
      const toggleBtn = document.getElementById('sidebarToggle');
      const backdrop = document.getElementById('mobile-backdrop');

      function openSidebar() {
        if (!sidebar) return;
        sidebar.classList.remove('-translate-x-full');
        sidebar.setAttribute('aria-hidden', 'false');
        if (backdrop) backdrop.classList.remove('hidden');
      }
      function closeSidebar() {
        if (!sidebar) return;
        sidebar.classList.add('-translate-x-full');
        sidebar.setAttribute('aria-hidden', 'true');
        if (backdrop) backdrop.classList.add('hidden');
      }

      if (toggleBtn) {
        toggleBtn.addEventListener('click', () => {
          if (!sidebar) return;
          if (sidebar.classList.contains('-translate-x-full')) openSidebar();
          else closeSidebar();
        });
      }

      if (backdrop) {
        backdrop.addEventListener('click', closeSidebar);
      }

      // Close sidebar when resizing to large screens (cleanup)
      window.addEventListener('resize', () => {
        if (window.innerWidth >= 1024 && sidebar) {
          sidebar.classList.remove('-translate-x-full');
          sidebar.setAttribute('aria-hidden', 'false');
          if (backdrop) backdrop.classList.add('hidden');
        }
      });
    })();

    // Flash messages auto-hide + manual close
    (function() {
      const flashContainer = document.getElementById('flash-container');
      if (!flashContainer) return;
      
      flashContainer.querySelectorAll('.flash').forEach((el) => {
        const timeout = parseInt(el.dataset.timeout || '10000', 10);
        let timer = setTimeout(() => {
          el.classList.add('fade-out');
          setTimeout(() => el.remove(), 450);
        }, timeout);
        
        const btn = el.querySelector('.close');
        if (btn) {
          btn.addEventListener('click', () => {
            clearTimeout(timer);
            el.classList.add('fade-out');
            setTimeout(() => el.remove(), 260);
          });
        }
      });
    })();

    // Notifications functionality - Enhanced Futuristic
    (function() {
      if (!{% if user.is_superuser %}true{% else %}false{% endif %}) return; // Only for superuser

      let readIds = JSON.parse(localStorage.getItem('readNotifications') || '[]');
      let allNotifications = [];
      let dropdownOpen = false;

      const bellContainer = document.getElementById('bell-container');
      const dropdown = document.getElementById('notifications-dropdown');
      const bell = document.getElementById('notifications-bell');
      const notificationsList = document.getElementById('notifications-list');
      const markAllBtn = document.getElementById('mark-all-read');
      const notifySound = document.getElementById('notifySound');

      function updateBadge(count) {
        const badge = document.getElementById('unread-badge');
        if (count > 0) {
          badge.textContent = count > 99 ? '99+' : count;
          badge.style.display = 'flex';
        } else {
          badge.style.display = 'none';
        }
      }

      function markAsRead(id) {
        if (!readIds.includes(id)) {
          readIds.push(id);
          // Play subtle sound on read
          notifySound.volume = 0.3;
          notifySound.currentTime = 0;
          notifySound.play().catch(() => {});
        }
        localStorage.setItem('readNotifications', JSON.stringify(readIds));
        populateList();
        const unreadCount = allNotifications.filter(n => !readIds.includes(n.id)).length;
        updateBadge(unreadCount);
      }

      function markAsUnread(id) {
        const index = readIds.indexOf(id);
        if (index > -1) {
          readIds.splice(index, 1);
        }
        localStorage.setItem('readNotifications', JSON.stringify(readIds));
        populateList();
        const unreadCount = allNotifications.filter(n => !readIds.includes(n.id)).length;
        updateBadge(unreadCount);
      }

      function markAllAsRead() {
        const previouslyUnread = allNotifications.filter(n => !readIds.includes(n.id));
        allNotifications.forEach(n => {
          if (!readIds.includes(n.id)) {
            readIds.push(n.id);
          }
        });
        localStorage.setItem('readNotifications', JSON.stringify(readIds));
        populateList();
        updateBadge(0);
        closeDropdown(); // Close the dropdown after marking all as read
        // Haptic feedback simulation
        if (navigator.vibrate) navigator.vibrate(50);
      }

      function formatRelativeTime(date) {
        const now = new Date();
        const diff = now - date;
        const seconds = Math.floor(diff / 1000);
        const minutes = seconds / 60;
        const hours = minutes / 60;
        const days = hours / 24;
        if (days > 1) return `${Math.floor(days)}d ago`;
        if (hours > 1) return `${Math.floor(hours)}h ago`;
        if (minutes > 1) return `${Math.floor(minutes)}m ago`;
        return 'Just now';
      }

      function populateList() {
        if (allNotifications.length === 0) {
          notificationsList.innerHTML = '<li class="p-3 text-center text-gray-500">No notifications yet. Stay tuned! ðŸš€</li>';
          return;
        }
        // Sort by date descending
        const sortedNotifications = [...allNotifications].sort((a, b) => new Date(b.created) - new Date(a.created));
        notificationsList.innerHTML = sortedNotifications.map(n => {
          const isRead = readIds.includes(n.id);
          const relativeTime = formatRelativeTime(new Date(n.created));
          return `
            <li class="p-3 ${isRead ? 'notification-read' : 'notification-unread'} hover:bg-gray-50 cursor-pointer" data-id="${n.id}" role="menuitem">
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <p class="text-sm font-medium text-gray-900">${n.message}</p>
                  <p class="relative-time mt-1">${relativeTime}</p>
                </div>
                <div class="flex gap-1 ml-2">
                  <button class="mark-btn mark-read ${isRead ? 'hidden' : ''}" data-id="${n.id}" aria-label="Mark this notification as read">Mark as Read</button>
                  <button class="mark-btn mark-unread ${!isRead ? 'hidden' : ''}" data-id="${n.id}" aria-label="Mark this notification as unread">Mark as Unread</button>
                </div>
              </div>
            </li>
          `;
        }).join('');
      }

      function openDropdown() {
        dropdown.classList.remove('hidden');
        dropdownOpen = true;
        populateList();
        // Auto-close after 10s inactivity
        clearTimeout(window.dropdownTimeout);
        window.dropdownTimeout = setTimeout(closeDropdown, 10000);
      }

      function closeDropdown() {
        dropdown.classList.add('hidden');
        dropdownOpen = false;
        clearTimeout(window.dropdownTimeout);
      }

      async function fetchNotifications() {
        try {
          const response = await fetch('{% url "pos:get_notifications" %}');
          const data = await response.json();
          const prevUnread = allNotifications.filter(n => !readIds.includes(n.id)).length;
          allNotifications = data.notifications;
          const unread = allNotifications.filter(n => !readIds.includes(n.id));
          updateBadge(unread.length);

          // Play sound and glow if new unread
          if (unread.length > prevUnread && unread.length > 0 && !window.notificationSoundPlayed) {
            notifySound.play().catch(e => console.log('Sound play failed:', e));
            window.notificationSoundPlayed = true;
          }

          if (dropdownOpen) {
            populateList();
          }
        } catch (e) {
          console.error('Error fetching notifications:', e);
        }
      }

      // Event delegation for mark buttons
      notificationsList.addEventListener('click', (e) => {
        if (e.target.classList.contains('mark-read')) {
          const id = e.target.dataset.id;
          markAsRead(id);
          e.stopPropagation();
        } else if (e.target.classList.contains('mark-unread')) {
          const id = e.target.dataset.id;
          markAsUnread(id);
          e.stopPropagation();
        }
      });

      // Hover to pause auto-close
      dropdown.addEventListener('mouseenter', () => clearTimeout(window.dropdownTimeout));
      dropdown.addEventListener('mouseleave', () => {
        if (dropdownOpen) {
          window.dropdownTimeout = setTimeout(closeDropdown, 3000);
        }
      });

      // Event listeners
      bell.addEventListener('click', (e) => {
        e.stopPropagation();
        if (dropdownOpen) {
          closeDropdown();
        } else {
          openDropdown();
        }
      });

      markAllBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        markAllAsRead();
      });

      // Close on outside click
      document.addEventListener('click', (e) => {
        if (dropdownOpen && !bellContainer.contains(e.target)) {
          closeDropdown();
        }
      });

      // Close on escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && dropdownOpen) {
          closeDropdown();
        }
      });

      // Enhanced polling with exponential backoff on error
      let pollInterval = 30000;
      async function pollNotifications() {
        await fetchNotifications();
        setTimeout(pollNotifications, pollInterval);
      }
      pollNotifications(); // Initial load
    })();
  </script>
</body>
</html>