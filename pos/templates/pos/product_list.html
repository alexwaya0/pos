{% extends 'pos/base.html' %}
{% load humanize %}
{% block title %}Products{% endblock %}
{% block page_title %}Product Inventory{% endblock %}
{% block content %}
<style>
  .dashboard-container {
    animation: fadeSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    opacity: 0;
    transform: translateY(10px);
  }
  @keyframes fadeSlideIn {
    to { opacity: 1; transform: translateY(0); }
  }
  .card {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: none;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08), 0 1px 3px rgba(0, 0, 0, 0.1);
    position: relative;
    padding: 20px;
    overflow: hidden;
    backdrop-filter: blur(10px);
  }
  .card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--gold), var(--darkgreen));
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  .card:hover {
    transform: translateY(-4px) scale(1.02);
    box-shadow: 0 12px 40px rgba(6, 68, 32, 0.15), 0 2px 8px rgba(0, 0, 0, 0.1);
  }
  .card:hover::before { opacity: 1; }
  /* Card-specific colors - pharmacy-themed with advanced gradients */
  .card-products { 
    background: linear-gradient(145deg, #E6F0FA 0%, #D1E7F5 50%, rgba(209, 231, 245, 0.8) 100%); 
    border: 1px solid rgba(37, 99, 235, 0.1);
  }
  .card-lowstock { 
    background: linear-gradient(145deg, #FEF2F2 0%, #FEE2E2 50%, rgba(254, 226, 226, 0.8) 100%); 
    border: 1px solid rgba(239, 68, 68, 0.1);
  }
  .card-price { 
    background: linear-gradient(145deg, #F0FDF4 0%, #DCFCE7 50%, rgba(220, 252, 231, 0.8) 100%); 
    border: 1px solid rgba(34, 197, 94, 0.1);
  }
  .cta-link {
    color: var(--darkgreen);
    font-weight: 500;
    font-size: 0.85rem;
    position: absolute;
    bottom: 12px;
    right: 12px;
    display: flex;
    align-items: center;
    transition: all 0.3s ease;
    text-decoration: none;
  }
  .cta-link:hover {
    color: var(--gold);
    transform: translateX(4px) scale(1.05);
  }
  .cta-icon {
    width: 14px;
    height: 14px;
    margin-left: 4px;
    transition: all 0.2s ease;
  }
  .cta-link:hover .cta-icon { transform: scale(1.1) rotate(10deg); }
  .metric-icon {
    width: 44px;
    height: 44px;
    background: rgba(255, 255, 255, 0.7);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 12px;
    flex-shrink: 0;
    transition: all 0.3s ease;
  }
  .card:hover .metric-icon {
    background: rgba(255, 255, 255, 0.9);
    transform: scale(1.05);
  }
  .metric-title {
    font-size: 0.875rem;
    font-weight: 500;
    color: #6b7280;
    margin: 0 0 4px 0;
    line-height: 1.2;
  }
  .metric-value {
    font-size: 1.875rem;
    font-weight: 700;
    margin: 0;
    line-height: 1.1;
  }
  .table-container {
    background: #ffffff;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    padding: 24px;
    overflow-x: auto;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    min-width: 800px;
  }
  th, td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #f1f5f9;
  }
  th {
    background-color: var(--darkgreen);
    color: #ffffff;
    font-weight: 600;
    position: sticky;
    top: 0;
    z-index: 10;
  }
  tr:hover {
    background-color: #f8fafc;
  }
  tr.low-stock {
    background-color: #fef2f2;
  }
  .sell-btn {
    background: linear-gradient(135deg, var(--gold), var(--gold-dark));
    color: var(--darkgreen);
    padding: 6px 12px;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 0.75rem;
  }
  .sell-btn:hover {
    transform: translateY(-1px) scale(1.05);
    box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
  }
  .search-container {
    position: relative;
    margin-bottom: 16px;
  }
  input#search {
    border: 1px solid var(--glass-border);
    border-radius: 8px;
    padding: 12px 16px 12px 40px;
    width: 100%;
    transition: all 0.3s ease;
    background: var(--glass-bg);
    backdrop-filter: blur(10px);
  }
  input#search:focus {
    border-color: var(--gold);
    outline: none;
    box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
  }
  h3 {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--darkgreen);
    margin: 0 0 8px 0;
  }
  .alert-badge {
    background: #ef4444;
    color: white;
    padding: 4px 8px;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: bold;
  }
  .no-data {
    text-align: center;
    color: var(--muted);
    padding: 40px;
    font-style: italic;
  }
  /* Pagination Styles */
  .pagination-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid #e2e8f0;
    flex-wrap: wrap;
    gap: 8px;
  }
  .pagination-controls select,
  .pagination-controls button {
    padding: 8px 12px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    background: white;
    cursor: pointer;
    font-size: 0.875rem;
    transition: all 0.2s ease;
  }
  .pagination-controls button:hover:not(:disabled) {
    background: #f3f4f6;
    border-color: #9ca3af;
  }
  .pagination-controls button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .pagination-controls label {
    margin-right: 8px;
    font-size: 0.875rem;
    color: #6b7280;
  }
  /* Sorting Styles */
  .sortable {
    cursor: pointer;
    user-select: none;
    position: relative;
    padding-right: 20px;
  }
  .sortable:hover {
    background-color: rgba(255, 255, 255, 0.1);
  }
  .sort-indicator {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 0.8em;
    opacity: 0.3;
    transition: opacity 0.2s ease, transform 0.2s ease;
  }
  .sorted .sort-indicator {
    opacity: 1;
  }
  .sorted.asc .sort-indicator {
    transform: translateY(-50%) rotate(0deg);
    content: '↑';
  }
  .sorted.desc .sort-indicator {
    transform: translateY(-50%) rotate(180deg);
    content: '↓';
  }
  /* Filter Styles */
  .filter-container {
    display: flex;
    gap: 8px;
    align-items: center;
  }
  .filter-container select {
    padding: 8px 12px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    background: white;
    font-size: 0.875rem;
  }
  /* Responsive adjustments */
  @media (max-width: 768px) {
    .card {
      padding: 16px;
      margin-bottom: 16px;
    }
    .metric-icon {
      width: 40px;
      height: 40px;
      margin-right: 8px;
    }
    .metric-value {
      font-size: 1.5rem;
    }
    .metric-title {
      font-size: 0.8rem;
    }
    .cta-link {
      font-size: 0.8rem;
      bottom: 8px;
      right: 8px;
    }
    .pagination-controls {
      flex-direction: column;
      align-items: stretch;
    }
    .pagination-controls > div:first-child {
      order: 2;
    }
    .pagination-controls #pageInfo {
      order: 1;
      text-align: center;
    }
    .pagination-controls > div:last-child {
      order: 3;
      justify-content: center;
    }
  }
  @media (max-width: 480px) {
    table {
      min-width: 600px;
    }
    th, td {
      padding: 8px 4px;
      font-size: 0.875rem;
    }
    .sell-btn {
      padding: 4px 8px;
      font-size: 0.7rem;
    }
  }
</style>

<div class="dashboard-container container mx-auto px-4">
  <!-- Summary Cards Grid -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
    <!-- Total Products Card -->
    <div class="card card-products relative">
      <div class="flex items-center mb-4">
        <div class="metric-icon">
          <i data-lucide="package" class="w-5 h-5 text-var(--darkgreen)"></i>
        </div>
        <div class="flex-1 min-w-0">
          <p class="metric-title">Total Products</p>
          <p class="metric-value text-var(--darkgreen)">{{ products|length|intcomma }}</p>
        </div>
      </div>
      <a href="{% url 'pos:product_add' %}" class="cta-link" aria-label="Add new product">
        Add Product
        <i data-lucide="plus" class="cta-icon"></i>
      </a>
    </div>

    <!-- Low Stock Alerts Card -->
    <div class="card card-lowstock relative">
      <div class="flex items-center mb-4">
        <div class="metric-icon bg-red-100/80">
          <i data-lucide="alert-triangle" class="w-5 h-5 text-red-600"></i>
        </div>
        <div class="flex-1 min-w-0">
          <p class="metric-title">Low Stock Items</p>
          <p class="metric-value text-red-600">{{ low_stock_count|default:0 }}</p> <!-- Extend view to pass low_stock_count -->
        </div>
      </div>
      <a href="?filter=low_stock" class="cta-link" aria-label="View low stock items">
        View Low Stock
        <i data-lucide="arrow-right" class="cta-icon"></i>
      </a>
    </div>

    <!-- Average Price Card -->
    <div class="card card-price relative">
      <div class="flex items-center mb-4">
        <div class="metric-icon bg-green-100/80">
          <i data-lucide="tag" class="w-5 h-5 text-green-600"></i>
        </div>
        <div class="flex-1 min-w-0">
          <p class="metric-title">Avg. Selling Price</p>
          <p class="metric-value text-green-600">KSh {{ avg_price|default:0|floatformat:0 }}</p> <!-- Extend view to pass avg_price -->
        </div>
      </div>
      <a href="#" class="cta-link" aria-label="View pricing details">
        Details
        <i data-lucide="arrow-right" class="cta-icon"></i>
      </a>
    </div>
  </div>

  <!-- Search and Filter Section -->
  <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-4 gap-4">
    <h3>Products List</h3>
    <div style="width: 300px;">
      <div class="search-container">
        <i data-lucide="search" class="absolute left-3 top-3 w-4 h-4 text-gray-400 pointer-events-none"></i>
        <input type="text" id="search" placeholder="Search by name or category..." aria-label="Search products">
      </div>
    </div>
    <div class="filter-container">
      <label for="filterSelect" class="text-sm text-gray-600">Filter:</label>
      <select id="filterSelect">
        <option value="all">All Products</option>
        <option value="low_stock">Low Stock</option>
      </select>
    </div>
  </div>

  <!-- Products Table -->
  <div class="table-container">
    {% if products %}
      <table id="products-table">
        <thead>
          <tr>
            <th class="sortable" data-column="name">Product <span class="sort-indicator">↕</span></th>
            <th class="sortable" data-column="category">Category <span class="sort-indicator">↕</span></th>
            <th class="sortable" data-column="price">Selling Price <span class="sort-indicator">↕</span></th>
            <th class="sortable" data-column="min_price">Min Price <span class="sort-indicator">↕</span></th>
            <th class="sortable" data-column="stock">Stock Level <span class="sort-indicator">↕</span></th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for product in products %}
            <tr 
              data-product-id="{{ product.id }}"
              data-sort-name="{{ product.name|lower }}" 
              data-sort-category="{{ product.category|lower }}" 
              data-sort-price="{{ product.price }}" 
              data-sort-stock="{{ product.total_stock|default:0 }}" 
              data-sort-minprice="{{ product.min_price }}"
              class="{% if product.total_stock|default:0 <= 10 %}low-stock{% endif %}">
              <td>{{ product.name }}</td>
              <td>{{ product.category }}</td>
              <td>KSh {{ product.price|floatformat:2 }}</td>
              <td>KSh {{ product.min_price|floatformat:2 }}</td>
              <td>
                {{ product.total_stock|default:0 }}
                {% if product.total_stock|default:0 <= 10 %}<span class="alert-badge ml-2">Low</span>{% endif %}
              </td>
              <td>
                <button class="sell-btn" onclick="quickSell({{ product.id }})" aria-label="Quick sell {{ product.name }}">
                  <i data-lucide="shopping-cart" class="w-3 h-3"></i>
                  Sell
                </button>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="pagination-controls">
        <div>
          <label for="pageSize">Rows per page:</label>
          <select id="pageSize">
            <option value="10" selected>10</option>
            <option value="25">25</option>
            <option value="all">All</option>
          </select>
        </div>
        <div id="pageInfo" class="text-sm text-gray-500">Showing 1 to {{ products|length }} of {{ products|length }} entries</div>
        <div class="flex gap-2">
          <button id="prev" disabled>Previous</button>
          <button id="next">Next</button>
        </div>
      </div>
    {% else %}
      <div class="no-data">No products available. <a href="{% url 'pos:product_add' %}" class="text-var(--gold)">Add your first product?</a></div>
    {% endif %}
  </div>
</div>

<script>
  // Render Lucide icons lazily
  lucide.createIcons({lazy: true});

  // Quick sell function
  function quickSell(productId) {
    window.location.href = `{% url 'pos:sale_create' %}?product=${productId}`;
  }

  // Dynamic Table Pagination/Sorting/Filter
  document.addEventListener('DOMContentLoaded', () => {
    // Trigger animation
    document.querySelector('.dashboard-container').style.opacity = '1';

    const searchInput = document.getElementById('search');
    const filterSelect = document.getElementById('filterSelect');
    const pageSizeSelect = document.getElementById('pageSize');
    const prevBtn = document.getElementById('prev');
    const nextBtn = document.getElementById('next');
    const pageInfo = document.getElementById('pageInfo');
    const tableBody = document.querySelector('#products-table tbody');
    
    if (tableBody) {
      const originalRows = Array.from(tableBody.querySelectorAll('tr'));
      let currentRows = [...originalRows];
      let currentPage = 1;
      let sortColumn = 'name';
      let sortDirection = 'asc';

      function sortRows(column, rowsToSort) {
        rowsToSort.sort((a, b) => {
          let aVal = a.dataset[`sort-${column}`] || '';
          let bVal = b.dataset[`sort-${column}`] || '';
          if (['price', 'stock', 'min_price'].includes(column)) {
            aVal = parseFloat(aVal) || 0;
            bVal = parseFloat(bVal) || 0;
          } else {
            aVal = aVal.toString().toLowerCase();
            bVal = bVal.toString().toLowerCase();
          }
          if (aVal < bVal) {
            return sortDirection === 'asc' ? -1 : 1;
          } else if (aVal > bVal) {
            return sortDirection === 'asc' ? 1 : -1;
          } else {
            return 0;
          }
        });
      }

      function updateHeaders() {
        const headers = document.querySelectorAll('th[data-column]');
        headers.forEach(th => {
          th.classList.remove('sorted', 'asc', 'desc');
          const indicator = th.querySelector('.sort-indicator');
          if (indicator) indicator.textContent = '↕';
        });
        if (sortColumn) {
          const activeHeader = document.querySelector(`th[data-column="${sortColumn}"]`);
          if (activeHeader) {
            activeHeader.classList.add('sorted', sortDirection);
            const indicator = activeHeader.querySelector('.sort-indicator');
            indicator.textContent = sortDirection === 'asc' ? '↑' : '↓';
          }
        }
      }

      function renderTable() {
        const term = searchInput.value.toLowerCase();
        const filter = filterSelect.value;
        let filtered = originalRows.filter(row => {
          const name = row.cells[0] ? row.cells[0].textContent.toLowerCase() : '';
          const category = row.cells[1] ? row.cells[1].textContent.toLowerCase() : '';
          const stock = parseInt(row.dataset['sort-stock']) || 0;
          if (term && !name.includes(term) && !category.includes(term)) return false;
          if (filter === 'low_stock' && stock > 10) return false;
          return true;
        });
        
        // Sort the filtered rows
        sortRows(sortColumn, filtered);
        currentRows = filtered;
        
        const pageSize = pageSizeSelect.value;
        const rpp = pageSize === 'all' ? Infinity : parseInt(pageSize);
        const totalFiltered = filtered.length;
        let totalPages = rpp === Infinity ? 1 : Math.ceil(totalFiltered / rpp);
        if (totalPages === 0) totalPages = 1;
        
        if (currentPage > totalPages) currentPage = totalPages;
        
        const start = (currentPage - 1) * rpp;
        const end = start + rpp;
        
        // Hide all rows
        originalRows.forEach(row => row.style.display = 'none');
        
        // Show relevant slice
        const toShow = rpp === Infinity ? filtered : filtered.slice(start, end);
        toShow.forEach(row => row.style.display = '');
        
        // Update page info
        const showingFrom = totalFiltered === 0 ? 0 : start + 1;
        const showingTo = Math.min(end, totalFiltered);
        pageInfo.textContent = `Showing ${showingFrom} to ${showingTo} of ${totalFiltered} entries`;
        
        // Update buttons
        prevBtn.disabled = currentPage === 1;
        nextBtn.disabled = currentPage === totalPages || totalFiltered === 0;
      }

      // Initial sort and render
      sortRows(sortColumn, currentRows);
      updateHeaders();
      renderTable();

      // Event listeners
      let searchTimeout;
      searchInput.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          currentPage = 1;
          renderTable();
        }, 300);
      });

      filterSelect.addEventListener('change', () => {
        currentPage = 1;
        renderTable();
      });

      pageSizeSelect.addEventListener('change', () => {
        currentPage = 1;
        renderTable();
      });

      prevBtn.addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          renderTable();
        }
      });

      nextBtn.addEventListener('click', () => {
        currentPage++;
        renderTable();
      });

      // Sorting event listener
      document.addEventListener('click', (e) => {
        const th = e.target.closest('th[data-column]');
        if (!th) return;
        const column = th.dataset.column;
        if (column === 'actions') return;
        if (sortColumn === column) {
          sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
          sortColumn = column;
          sortDirection = 'asc';
        }
        // Re-filter and sort
        renderTable();
      });

      // Handle URL filter on load
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('filter') === 'low_stock') {
        filterSelect.value = 'low_stock';
        renderTable();
      }

      // Real-time stock updates
      async function updateStocks() {
        try {
          const response = await fetch("{% url 'pos:product_list' %}", {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
          });
          const result = await response.json();
          const stocks = result.stocks;
          let lowStockCount = 0;
          stocks.forEach(stock => {
            const row = document.querySelector(`tr[data-product-id="${stock.id}"]`);
            if (row) {
              row.dataset.sortStock = stock.total_stock;
              const stockTd = row.cells[4]; // Stock level td (0-based index)
              stockTd.innerHTML = `
                ${stock.total_stock}
                ${stock.total_stock <= 10 ? '<span class="alert-badge ml-2">Low</span>' : ''}
              `;
              if (stock.total_stock <= 10) {
                row.classList.add('low-stock');
                lowStockCount++;
              } else {
                row.classList.remove('low-stock');
              }
            }
          });
          // Update low stock card
          const lowStockEl = document.querySelector('.card-lowstock .metric-value');
          if (lowStockEl) {
            lowStockEl.textContent = lowStockCount;
          }
          // Re-render to apply any filters/sorts
          renderTable();
        } catch (error) {
          console.error('Failed to update stocks:', error);
        }
      }

      // Initial update and poll every 30 seconds
      updateStocks();
      setInterval(updateStocks, 30000);
    }
  });
</script>
{% endblock %}