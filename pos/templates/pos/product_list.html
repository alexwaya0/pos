{% extends 'pos/base.html' %}
{% block content %}
<style>
  .card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border: none;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    position: relative;
    padding: 24px;
  }
  .card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0, 102, 102, 0.2);
  }
  /* Card-specific colors */
  .card-products { background: linear-gradient(145deg, #E6F0FA, #D1E7F5); } /* Light teal */
  .card-categories { background: linear-gradient(145deg, #E6F7F2, #CCEFE7); } /* Light green */
  .card-expiry { background: linear-gradient(145deg, #FEF7E6, #F6E9CC); } /* Light gold */
  .card-low-stock { background: linear-gradient(145deg, #F0E6F7, #E3D5EF); } /* Light purple */
  .cta-link {
    color: #006666; /* Teal */
    font-weight: 500;
    font-size: 0.9rem;
    position: absolute;
    bottom: 16px;
    right: 16px;
    display: flex;
    align-items: center;
    transition: color 0.3s ease, transform 0.2s ease;
  }
  .cta-link:hover {
    color: #1F7A5F; /* Jungle green */
    transform: translateX(5px);
  }
  .cta-icon {
    width: 16px;
    height: 16px;
    fill: currentColor;
    margin-left: 4px;
  }
  .table-container {
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    padding: 16px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
  }
  th, td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #e2e8f0;
  }
  th {
    background-color: #006666;
    color: #ffffff;
    font-weight: 600;
  }
  tr:hover {
    background-color: #f0f4f8;
  }
  .sell-btn {
    background-color: #D4A017;
    color: #1a202c;
    padding: 6px 12px;
    border-radius: 6px;
    transition: background-color 0.3s ease, transform 0.2s ease;
  }
  .sell-btn:hover {
    background-color: #1F7A5F;
    color: #ffffff;
    transform: scale(1.05);
  }
  input#search {
    border: 1px solid #006666;
    border-radius: 8px;
    padding: 8px;
    width: 100%;
    transition: border-color 0.3s ease;
  }
  input#search:focus {
    border-color: #D4A017;
    outline: none;
    box-shadow: 0 0 5px rgba(212, 160, 23, 0.5);
  }
  h3 {
    font-size: 1.25rem;
    font-weight: 600;
    color: #006666;
  }
  .icon {
    width: 24px;
    height: 24px;
    fill: #006666;
    margin-right: 8px;
  }
  .text-teal { color: #006666 !important; }
  .text-jungle-green { color: #1F7A5F !important; }
  .text-gold { color: #D4A017 !important; }
</style>

<div class="container mx-auto">
  <!-- Summary Cards -->
  <!-- <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
    <div class="card card-products">
      <div class="flex items-center mb-2">
        <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 6h-3V4c0-1.1-.9-2-2-2H9c-1.1 0-2 .9-2 2v2H4c-1.1 0-2 .9-2 2v11c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zM9 4h6v2H9V4zm11 15H4V8h3v2h2V8h6v2h2V8h3v11z"/></svg>
        <h3 class="text-gold">Total Products</h3>
      </div>
      <p class="text-2xl font-bold text-teal">{{ products|length }}</p>
      <a href="#" class="cta-link" aria-label="View all products">
        View
        <svg class="cta-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"/></svg>
      </a>
    </div>
    <div class="card card-categories">
      <div class="flex items-center mb-2">
        <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 5h16v2H4zm0 6h16v2H4zm0 6h16v2H4z"/></svg>
        <h3 class="text-gold">Total Categories</h3>
      </div>
      <p class="text-2xl font-bold text-teal">{{ categories|length }}</p>
      <a href="#" class="cta-link" aria-label="View all categories">
        View
        <svg class="cta-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"/></svg>
      </a>
    </div>
    <div class="card card-expiry">
      <div class="flex items-center mb-2">
        <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
        <h3 class="text-gold">About to Expire</h3>
      </div>
      <p class="text-2xl font-bold text-teal">{{ near_expiries|length }}</p>
      <a href="#" class="cta-link" aria-label="View expiring products">
        View
        <svg class="cta-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"/></svg>
      </a>
    </div>
    <div class="card card-low-stock">
      <div class="flex items-center mb-2">
        <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4z"/></svg>
        <h3 class="text-gold">Low in Stock</h3>
      </div>
      <p class="text-2xl font-bold text-teal">{{ low_stocks|length }}</p>
      <a href="#" class="cta-link" aria-label="View low stock products">
        View
        <svg class="cta-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"/></svg>
      </a>
    </div>
  </div> -->

  <!-- Product Table -->
  <div class="table-container">
    <h3 class="mb-4 text-teal">Products</h3>
    <div class="mb-4">
      <input type="text" id="search" placeholder="Search products..." class="w-full">
    </div>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Category</th>
          <th>Price (KES)</th>
          <th>Min Price (KES)</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="product-table">
        {% for product in products %}
          <tr data-name="{{ product.name|lower }}">
            <td>{{ product.name }}</td>
            <td>{{ product.category }}</td>
            <td>{{ product.price|floatformat:2 }}</td>
            <td>{{ product.min_price|floatformat:2 }}</td>
            <td>
              <a href="{% url 'pos:sale_create' %}?product={{ product.id }}" class="sell-btn">Sell</a>
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="5" class="text-center text-gray-500">No products available</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Role-Specific Data -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8">
    {% if role == 'cashier' %}
      <div class="card card-products p-6">
        <h3 class="text-gold">Today's Sales</h3>
        <p class="text-sm text-gray-500">Total sales for {{ request.user.profile.branch.name }}</p>
        <div class="mt-4 text-2xl font-bold text-teal">KES {{ today_sales|floatformat:2 }}</div>
      </div>
      <div class="card card-products p-6">
        <h3 class="text-gold">Low Stock Alerts</h3>
        <p class="text-sm text-gray-500">Items below threshold</p>
        <ul class="mt-4 text-sm text-jungle-green">
          {% for batch in low_stocks %}
            <li class="py-1">{{ batch.product.name }}: {{ batch.quantity }} units</li>
          {% empty %}
            <li class="py-1">No low stock items</li>
          {% endfor %}
        </ul>
      </div>
      <div class="card card-products p-6">
        <h3 class="text-gold">Expiry Warnings</h3>
        <p class="text-sm text-gray-500">Items nearing expiry</p>
        <ul class="mt-4 text-sm text-jungle-green">
          {% for batch in near_expiries %}
            <li class="py-1">{{ batch.product.name }}: {{ batch.expiry_date|date:"d/m/Y" }}</li>
          {% empty %}
            <li class="py-1">No expiring items</li>
          {% endfor %}
        </ul>
      </div>
    {% elif role == 'manager' %}
      <div class="card card-products p-6">
        <h3 class="text-gold">Branch Sales Summary</h3>
        <p class="text-sm text-gray-500">{{ request.user.profile.branch.name }}</p>
        <div class="mt-4 text-2xl font-bold text-teal">KES {{ sales_summary|floatformat:2 }}</div>
      </div>
      <div class="card card-products p-6">
        <h3 class="text-gold">Low Stock Alerts</h3>
        <p class="text-sm text-gray-500">Items below threshold</p>
        <ul class="mt-4 text-sm text-jungle-green">
          {% for batch in low_stocks %}
            <li class="py-1">{{ batch.product.name }}: {{ batch.quantity }} units</li>
          {% empty %}
            <li class="py-1">No low stock items</li>
          {% endfor %}
        </ul>
      </div>
      <div class="card card-products p-6">
        <h3 class="text-gold">Expiry Warnings</h3>
        <p class="text-sm text-gray-500">Items nearing expiry</p>
        <ul class="mt-4 text-sm text-jungle-green">
          {% for batch in near_expiries %}
            <li class="py-1">{{ batch.product.name }}: {{ batch.expiry_date|date:"d/m/Y" }}</li>
          {% empty %}
            <li class="py-1">No expiring items</li>
          {% endfor %}
        </ul>
      </div>
    {% elif role == 'admin' %}
      {% for branch, total in branch_sales.items %}
      <div class="card card-products p-6">
        <h3 class="text-gold">{{ branch }}</h3>
        <p class="text-sm text-gray-500">Total Sales</p>
        <div class="mt-4 text-2xl font-bold text-teal">KES {{ total|floatformat:2 }}</div>
      </div>
      {% endfor %}
      <div class="card card-products p-6">
        <h3 class="text-gold">All Alerts</h3>
        <p class="text-sm text-gray-500">Across all branches</p>
        <ul class="mt-4 text-sm text-jungle-green">
          {% for notification in notifications %}
            <li class="py-1">{{ notification.message }} ({{ notification.created|date:"d/m/Y" }})</li>
          {% empty %}
            <li class="py-1">No active alerts</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}
  </div>
</div>

<script>
  // Search functionality for product table
  document.getElementById('search').addEventListener('input', function(e) {
    const term = e.target.value.toLowerCase();
    document.querySelectorAll('#product-table tr').forEach(row => {
      const name = row.dataset.name || '';
      row.style.display = name.includes(term) ? '' : 'none';
    });
  });
</script>
{% endblock %}