{% extends "pos/base.html" %}
{% block title %}Reports{% endblock %}
{% block page_title %}Reports{% endblock %}
{% block content %}
<style>
  .card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border: none;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    padding: 24px;
    background: #ffffff;
  }
  .card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0, 102, 102, 0.2);
  }
  .table-container {
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    padding: 16px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
  }
  th, td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #e2e8f0;
  }
  th {
    background-color: #006666;
    color: #ffffff;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  th:hover {
    background-color: #1F7A5F;
  }
  tr:hover {
    background-color: #f0f4f8;
  }
  .filter-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
  }
  .filter-container select, .filter-container input, .filter-container button {
    border: 1px solid #006666;
    border-radius: 8px;
    padding: 8px;
    transition: border-color 0.3s ease;
  }
  .filter-container select:focus, .filter-container input:focus, .filter-container button:focus {
    border-color: #D4A017;
    outline: none;
    box-shadow: 0 0 5px rgba(212, 160, 23, 0.5);
  }
  .filter-container button {
    background-color: #006666;
    color: #ffffff;
    cursor: pointer;
  }
  .filter-container button:hover {
    background-color: #1F7A5F;
  }
  .filter-container button.reset {
    background-color: #D4A017;
  }
  .filter-container button.reset:hover {
    background-color: #b58900;
  }
  h3 {
    font-size: 1.25rem;
    font-weight: 600;
    color: #006666;
  }
  .text-teal { color: #006666 !important; }
  .text-orange { color: #F97316 !important; }
  .text-gold { color: #D4A017 !important; }
  .sort-icon {
    display: inline-block;
    width: 12px;
    height: 12px;
    margin-left: 4px;
    vertical-align: middle;
  }
  .collapsible-header {
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
  }
  .collapsible-content {
    display: none;
  }
  .collapsible-content.active {
    display: block;
  }
  .search-input {
    width: 100%;
    max-width: 300px;
    margin-bottom: 1rem;
  }
  .no-data {
    text-align: center;
    color: #666;
    padding: 20px;
  }
  .profit-positive {
    color: #10b981 !important; /* Green for positive profit */
  }
  .profit-negative {
    color: #ef4444 !important; /* Red for negative profit/loss */
  }
  .currency-kes {
    font-weight: bold;
    font-size: 1.1em;
  }
  .turnover-high {
    color: #10b981 !important; /* Green for high turnover (>2) */
  }
  .turnover-low {
    color: #ef4444 !important; /* Red for low turnover (<1) */
  }
  .turnover-medium {
    color: #f59e0b !important; /* Amber for medium turnover (1-2) */
  }
  .chart-container {
    position: relative;
    height: 300px;
    width: 100%;
  }
  .chart-no-data {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    color: #666;
  }
  .pagination {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #e2e8f0;
  }
  .row-num {
    font-weight: bold;
    text-align: center;
    width: 50px;
  }
  @media (max-width: 768px) {
    .filter-container {
      grid-template-columns: 1fr;
      gap: 0.5rem;
    }
    table {
      font-size: 0.875rem;
    }
    th, td {
      padding: 8px 4px;
    }
    .chart-container {
      height: 250px;
    }
    .pagination {
      flex-direction: column;
      gap: 0.5rem;
    }
  }
</style>

<div class="container mx-auto space-y-8">
  <!-- Filters -->
  <form id="filter-form" action="{% url 'pos:reports' %}" method="get">
    <div class="card filter-container">
      <div>
        <label for="date-range" class="block text-sm font-medium text-gray-700">Date Range</label>
        <select id="date-range" name="date-range" class="w-full">
          <option value="today" {% if request.GET.date_range == 'today' %}selected{% endif %}>Today</option>
          <option value="week" {% if request.GET.date_range == 'week' %}selected{% endif %}>This Week</option>
          <option value="month" {% if request.GET.date_range == 'month' %}selected{% endif %}>This Month</option>
          <option value="custom" {% if request.GET.date_range == 'custom' %}selected{% endif %}>Custom</option>
        </select>
      </div>
      <div class="{% if request.GET.date_range != 'custom' %}hidden{% endif %}" id="custom-date">
        <label for="start-date" class="block text-sm font-medium text-gray-700">Start Date</label>
        <input type="date" id="start-date" name="start_date" value="{{ start_date }}" class="w-full" />
      </div>
      <div class="{% if request.GET.date_range != 'custom' %}hidden{% endif %}" id="custom-date-end">
        <label for="end-date" class="block text-sm font-medium text-gray-700">End Date</label>
        <input type="date" id="end-date" name="end_date" value="{{ end_date }}" class="w-full" />
      </div>
      <div>
        <label for="branch" class="block text-sm font-medium text-gray-700">Branch</label>
        <select id="branch" name="branch" class="w-full">
          <option value="" {% if not request.GET.branch %}selected{% endif %}>All Branches</option>
          {% for branch in branches %}
            <option value="{{ branch.id }}" {% if request.GET.branch == branch.id|stringformat:"s" %}selected{% endif %}>{{ branch.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label for="alert-type" class="block text-sm font-medium text-gray-700">Alert Type</label>
        <select id="alert-type" name="alert_type" class="w-full">
          <option value="" {% if not request.GET.alert_type %}selected{% endif %}>All Alerts</option>
          <option value="low_stock" {% if request.GET.alert_type == 'low_stock' %}selected{% endif %}>Low Stock</option>
          <option value="expiry" {% if request.GET.alert_type == 'expiry' %}selected{% endif %}>Near Expiry</option>
        </select>
      </div>
      <div class="flex items-end gap-2">
        <button type="submit" class="btn-primary">Apply Filters</button>
        <button type="button" class="reset" onclick="resetFilters()">Reset Filters</button>
      </div>
    </div>
  </form>

  <!-- Summary Cards -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <div class="card">
      <h3 class="text-gold">Total Sales</h3>
      <p class="text-2xl font-bold text-teal currency-kes">KES {{ total_sales|floatformat:2|default:"0.00" }}</p>
    </div>
    <div class="card">
      <h3 class="text-gold">Total Profit</h3>
      <p class="{% if total_profit < 0 %}profit-negative{% else %}profit-positive{% endif %} text-2xl font-bold currency-kes">KES {{ total_profit|floatformat:2|default:"0.00" }}</p>
    </div>
    <div class="card">
      <h3 class="text-gold">Inventory Turnover</h3>
      <p class="text-2xl font-bold text-teal">{{ inventory_turnover|default:"0.00" }}</p>
    </div>
    <div class="card">
      <h3 class="text-gold">Period</h3>
      <p class="text-lg text-teal">{{ start_date|date:"M d, Y" }} to {{ end_date|date:"M d, Y" }}</p>
    </div>
  </div>

  <!-- Charts Section -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
    <!-- Sales Trend Chart -->
    <div class="card">
      <h3 class="text-gold">Sales Trend</h3>
      <div class="chart-container" id="sales-chart-container">
        <canvas id="salesChart"></canvas>
        <div id="sales-no-data" class="chart-no-data" style="display: none;">No data available for the selected filters</div>
      </div>
    </div>

    <!-- Profit Trend Chart -->
    <div class="card">
      <h3 class="text-gold">Profit Trend</h3>
      <div class="chart-container" id="profit-chart-container">
        <canvas id="profitChart"></canvas>
        <div id="profit-no-data" class="chart-no-data" style="display: none;">No data available for the selected filters</div>
      </div>
    </div>

    <!-- Top Selling Products Pie Chart -->
    <div class="card">
      <h3 class="text-gold">Top Selling Products</h3>
      <div class="chart-container" id="top-products-chart-container">
        <canvas id="topProductsChart"></canvas>
        <div id="top-products-no-data" class="chart-no-data" style="display: none;">No data available for the selected filters</div>
      </div>
    </div>
  </div>

  <!-- Stock Report Table -->
  <div class="table-container">
    <div class="collapsible-header">
      <h3 class="text-gold">Stock Report</h3>
      <svg class="toggle-icon" width="24" height="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
    </div>
    <div class="collapsible-content active">
      <input type="text" id="stock-search" class="search-input" placeholder="Search by product...">
      <table id="stock-table">
        <thead>
          <tr>
            <th>#</th>
            <th data-sort="product_name">Product <svg class="sort-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg></th>
            <th data-sort="opening">Opening Stock <svg class="sort-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg></th>
            <th data-sort="sold">Sold <svg class="sort-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg></th>
            <th data-sort="closing">Closing Stock <svg class="sort-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg></th>
            <th data-sort="turnover">Turnover Rate <svg class="sort-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg></th>
          </tr>
        </thead>
        <tbody>
          {% for item in stock_report %}
            <tr>
              <td class="row-num"></td>
              <td>{{ item.product_name|default:"Unknown" }}</td>
              <td>{{ item.opening|default:0 }}</td>
              <td>{{ item.sold|default:0 }}</td>
              <td>{{ item.closing|default:0 }}</td>
              <td class="{% if item.turnover > 2 %}turnover-high{% elif item.turnover < 1 %}turnover-low{% else %}turnover-medium{% endif %}">{{ item.turnover|default:"0.00" }}</td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="6" class="no-data">No stock data available</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="pagination" id="stock-pagination"></div>
    </div>
  </div>

  <!-- Low Stock Alerts -->
  <div class="table-container" id="low-stock-container" {% if request.GET.alert_type == 'expiry' %}style="display:none"{% endif %}>
    <div class="collapsible-header">
      <h3 class="text-gold">Low Stock Alerts</h3>
      <svg class="toggle-icon" width="24" height="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
    </div>
    <div class="collapsible-content active">
      <input type="text" id="low-stock-search" class="search-input" placeholder="Search by product...">
      <table id="low-stock-table">
        <thead>
          <tr>
            <th>#</th>
            <th data-sort="product">Product <svg class="sort-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg></th>
            <th data-sort="quantity">Quantity <svg class="sort-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg></th>
            <th data-sort="branch">Branch <svg class="sort-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg></th>
          </tr>
        </thead>
        <tbody>
          {% for stock in low_stocks %}
            <tr data-type="low_stock">
              <td class="row-num"></td>
              <td>{{ stock.product.name|default:"Unknown" }}</td>
              <td>{{ stock.quantity|default:0 }}</td>
              <td>{{ stock.branch.name|default:"Unknown" }}</td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="4" class="no-data">No low stock items</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="pagination" id="low-stock-pagination"></div>
    </div>
  </div>

  <!-- Expiry Warnings -->
  <div class="table-container" id="expiry-container" {% if request.GET.alert_type == 'low_stock' %}style="display:none"{% endif %}>
    <div class="collapsible-header">
      <h3 class="text-gold">Expiry Warnings</h3>
      <svg class="toggle-icon" width="24" height="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
    </div>
    <div class="collapsible-content active">
      <input type="text" id="expiry-search" class="search-input" placeholder="Search by product...">
      <table id="expiry-table">
        <thead>
          <tr>
            <th>#</th>
            <th data-sort="product">Product <svg class="sort-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg></th>
            <th data-sort="expiry_date">Expiry Date <svg class="sort-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg></th>
            <th data-sort="branch">Branch <svg class="sort-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg></th>
          </tr>
        </thead>
        <tbody>
          {% for stock in near_expiries %}
            <tr data-type="expiry" data-expiry="{{ stock.expiry_date|date:'Y-m-d' }}">
              <td class="row-num"></td>
              <td>{{ stock.product.name|default:"Unknown" }}</td>
              <td>{{ stock.expiry_date|date:"M d, Y"|default:"N/A" }}</td>
              <td>{{ stock.branch.name|default:"Unknown" }}</td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="4" class="no-data">No expiring items</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="pagination" id="expiry-pagination"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Chart Data from Django Context (initial load)
  const initialDates = [{% for d in daily_data %}'{{ d.date|date:"M d" }}',{% endfor %}];
  const initialSalesData = [{% for d in daily_data %}{{ d.sales|float }},{% endfor %}];
  const initialProfitsData = [{% for d in daily_data %}{{ d.profit|float }},{% endfor %}];
  const initialTrendSales = {{ trend_sales|safe }};
  const initialTrendProfits = {{ trend_profits|safe }};
  const initialProductNames = [{% for m in most_selling %}'{{ m.product__name }}',{% endfor %}];
  const initialProductRevenues = [{% for m in most_selling %}{{ m.total_revenue|float }},{% endfor %}];

  let salesChart, profitChart, topProductsChart;

  function toggleChartVisibility(chartContainerId, canvasId, noDataId, hasData) {
    const container = document.getElementById(chartContainerId);
    const canvas = document.getElementById(canvasId);
    const noData = document.getElementById(noDataId);
    if (hasData) {
      canvas.style.display = 'block';
      noData.style.display = 'none';
    } else {
      canvas.style.display = 'none';
      noData.style.display = 'block';
    }
  }

  // Table Management Functions
  function initTable(tableId) {
    const table = document.getElementById(tableId);
    if (!table) return;

    const theadRow = table.tHead.rows[0];
    const newTh = document.createElement('th');
    newTh.textContent = '#';
    newTh.className = 'row-num-header';
    newTh.style.width = '50px';
    theadRow.insertBefore(newTh, theadRow.firstChild);

    const tbody = table.tBodies[0];
    Array.from(tbody.rows).forEach(row => {
      if (row.querySelector('.no-data')) return; // skip no-data row
      const newTd = document.createElement('td');
      newTd.className = 'row-num';
      row.insertBefore(newTd, row.firstChild);
    });

    // Update no-data colspan if present
    const noDataRow = tbody.querySelector('tr td.no-data');
    if (noDataRow) {
      noDataRow.colSpan = theadRow.cells.length;
    }

    // Set col types
    let colTypes = {};
    if (tableId === 'stock-table') {
      colTypes = {
        product_name: 'string',
        opening: 'number',
        sold: 'number',
        closing: 'number',
        turnover: 'number'
      };
    } else if (tableId === 'low-stock-table') {
      colTypes = {
        product: 'string',
        quantity: 'number',
        branch: 'string'
      };
    } else if (tableId === 'expiry-table') {
      colTypes = {
        product: 'string',
        expiry_date: 'date',
        branch: 'string'
      };
    } else if (tableId === 'notifications-table') {
      colTypes = {
        message: 'string',
        created: 'date'
      };
    }
    window[`${tableId}_colTypes`] = colTypes;

    // Init state
    window[`${tableId}_searchTerm`] = '';
    window[`${tableId}_rowsPerPage`] = 10;
    window[`${tableId}_currentPage`] = 1;

    // Add pagination controls
    const content = table.closest('.collapsible-content');
    const paginationDiv = document.getElementById(`${tableId}-pagination`) || document.createElement('div');
    paginationDiv.id = `${tableId}-pagination`;
    paginationDiv.className = 'pagination';
    paginationDiv.innerHTML = `
      <div class="flex items-center">
        <label class="mr-2 text-sm">Rows per page:</label>
        <select id="${tableId}-rows-select" class="border rounded px-2 py-1">
          <option value="10">10</option>
          <option value="25">25</option>
          <option value="1000">All</option>
        </select>
      </div>
      <div class="flex items-center">
        <button id="${tableId}-prev-btn" class="mr-2 px-3 py-1 bg-gray-200 rounded disabled:opacity-50" onclick="prevPage('${tableId}')">Previous</button>
        <span id="${tableId}-page-info" class="mx-2 text-sm"></span>
        <button id="${tableId}-next-btn" class="px-3 py-1 bg-gray-200 rounded disabled:opacity-50" onclick="nextPage('${tableId}')">Next</button>
      </div>
    `;
    if (!document.getElementById(`${tableId}-pagination`)) content.appendChild(paginationDiv);

    // Event listeners for pagination
    document.getElementById(`${tableId}-rows-select`).addEventListener('change', (e) => changeRowsPerPage(tableId, e.target.value));

    // Sort listeners
    table.querySelectorAll('th[data-sort]').forEach(th => {
      th.addEventListener('click', () => sortTable(tableId, th.dataset.sort));
    });

    // Initial display
    displayPage(tableId);
  }

  function getColumnIndex(table, column) {
    return Array.from(table.querySelectorAll('th')).findIndex(th => th.dataset.sort === column) + 1;
  }

  function displayPage(tableId) {
    const table = document.getElementById(tableId);
    if (!table) return;
    const tbody = table.tBodies[0];
    const allRows = Array.from(tbody.querySelectorAll('tr')).filter(row => !row.querySelector('.no-data')); // exclude no-data rows
    const searchTerm = window[`${tableId}_searchTerm`] || '';
    let filteredRows = allRows;

    // Filter
    if (searchTerm) {
      filteredRows = allRows.filter(row => {
        const productCell = row.cells[1]; // product column
        return productCell && productCell.textContent.toLowerCase().includes(searchTerm.toLowerCase());
      });
    }

    // Sort
    const sortTh = table.querySelector('th[data-sort][data-order]');
    let sortColumn = null;
    let isAsc = false;
    if (sortTh) {
      sortColumn = sortTh.dataset.sort;
      isAsc = sortTh.dataset.order === 'asc';
      const colTypes = window[`${tableId}_colTypes`];
      const colType = colTypes[sortColumn];
      const colCellIndex = getColumnIndex(table, sortColumn) - 1; // 0-based for cells

      filteredRows.sort((a, b) => {
        let aVal = a.cells[colCellIndex].textContent.trim();
        let bVal = b.cells[colCellIndex].textContent.trim();

        if (colType === 'number') {
          aVal = parseFloat(aVal) || 0;
          bVal = parseFloat(bVal) || 0;
          return isAsc ? aVal - bVal : bVal - aVal;
        } else if (colType === 'date') {
          aVal = a.dataset.expiry ? new Date(a.dataset.expiry) : new Date(aVal);
          bVal = b.dataset.expiry ? new Date(b.dataset.expiry) : new Date(bVal);
          return isAsc ? aVal - bVal : bVal - aVal;
        } else {
          aVal = aVal.toLowerCase();
          bVal = bVal.toLowerCase();
          return isAsc ? (aVal > bVal ? 1 : aVal < bVal ? -1 : 0) : (aVal < bVal ? 1 : aVal > bVal ? -1 : 0);
        }
      });
    }

    const rowsPerPage = window[`${tableId}_rowsPerPage`];
    const totalFiltered = filteredRows.length;
    let totalPages = Math.ceil(totalFiltered / rowsPerPage);
    let currentPage = window[`${tableId}_currentPage`];
    if (currentPage > totalPages) currentPage = totalPages;
    window[`${tableId}_currentPage`] = currentPage;

    const start = (currentPage - 1) * rowsPerPage;
    const end = Math.min(start + rowsPerPage, totalFiltered);

    // Hide all data rows
    allRows.forEach(row => row.style.display = 'none');

    // Show paginated rows and number them
    for (let i = start; i < end; i++) {
      const row = filteredRows[i];
      row.style.display = '';
      row.cells[0].textContent = (i + 1);
    }

    // Handle no-data row
    let noDataRow = tbody.querySelector('tr td.no-data');
    if (totalFiltered === 0) {
      if (!noDataRow) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="${table.tHead.rows[0].cells.length}" class="no-data">No data available</td>`;
        tbody.appendChild(tr);
      } else {
        noDataRow.parentNode.style.display = '';
      }
    } else if (noDataRow) {
      noDataRow.parentNode.style.display = 'none';
    }

    // Update pagination info and buttons
    const pageInfo = document.getElementById(`${tableId}-page-info`);
    if (totalFiltered === 0) {
      pageInfo.textContent = 'No entries to show';
    } else {
      pageInfo.textContent = `Page ${currentPage} of ${totalPages} | Showing ${start + 1} to ${end} of ${totalFiltered} entries`;
    }

    const prevBtn = document.getElementById(`${tableId}-prev-btn`);
    const nextBtn = document.getElementById(`${tableId}-next-btn`);
    prevBtn.disabled = currentPage <= 1;
    nextBtn.disabled = currentPage >= totalPages;
  }

  function sortTable(tableId, column) {
    const th = document.querySelector(`#${tableId} th[data-sort="${column}"]`);
    if (!th) return;
    const isAsc = th.dataset.order === 'asc';
    th.dataset.order = isAsc ? 'desc' : 'asc';
    updateSortIcons(tableId, column, !isAsc);
    window[`${tableId}_currentPage`] = 1;
    displayPage(tableId);
  }

  function updateSortIcons(tableId, column, isAsc) {
    const table = document.getElementById(tableId);
    if (!table) return;
    table.querySelectorAll('th .sort-icon').forEach(icon => {
      icon.innerHTML = '<path d="M7 10l5 5 5-5z"/>';
    });
    const activeIcon = table.querySelector(`th[data-sort="${column}"] .sort-icon`);
    if (activeIcon) {
      activeIcon.innerHTML = isAsc ? '<path d="M7 14l5-5 5 5z"/>' : '<path d="M7 10l5 5 5-5z"/>';
    }
  }

  function changeRowsPerPage(tableId, val) {
    window[`${tableId}_rowsPerPage`] = parseInt(val);
    window[`${tableId}_currentPage`] = 1;
    displayPage(tableId);
  }

  function prevPage(tableId) {
    if (window[`${tableId}_currentPage`] > 1) {
      window[`${tableId}_currentPage`]--;
      displayPage(tableId);
    }
  }

  function nextPage(tableId) {
    const totalPages = Math.ceil(getFilteredRowCount(tableId) / window[`${tableId}_rowsPerPage`]);
    if (window[`${tableId}_currentPage`] < totalPages) {
      window[`${tableId}_currentPage`]++;
      displayPage(tableId);
    }
  }

  function getFilteredRowCount(tableId) {
    // Approximate, call displayPage to update
    displayPage(tableId); // To ensure updated
    const table = document.getElementById(tableId);
    return Array.from(table.tBodies[0].querySelectorAll('tr')).filter(row => row.style.display !== 'none' && !row.querySelector('.no-data')).length;
  }

  function filterTable(tableId, searchTerm) {
    window[`${tableId}_searchTerm`] = searchTerm;
    window[`${tableId}_currentPage`] = 1;
    displayPage(tableId);
  }

  // Chart initialization
  document.addEventListener('DOMContentLoaded', () => {
    // Init tables
    ['stock-table', 'low-stock-table', 'expiry-table'].forEach(initTable); // Removed notifications-table

    const hasInitialData = initialDates.length > 0;
    toggleChartVisibility('sales-chart-container', 'salesChart', 'sales-no-data', hasInitialData);
    toggleChartVisibility('profit-chart-container', 'profitChart', 'profit-no-data', hasInitialData);
    toggleChartVisibility('top-products-chart-container', 'topProductsChart', 'top-products-no-data', initialProductNames.length > 0);

    if (!hasInitialData) return;

    // Initialize Charts
    const salesCtx = document.getElementById('salesChart').getContext('2d');
    salesChart = new Chart(salesCtx, {
      type: 'line',
      data: {
        labels: initialDates,
        datasets: [
          {
            label: 'Daily Sales (KES)',
            data: initialSalesData,
            borderColor: 'rgb(59, 130, 246)',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.1,
            fill: true
          },
          {
            label: 'Trend Line',
            data: initialTrendSales,
            borderColor: 'rgb(59, 130, 246)',
            borderDash: [5, 5],
            fill: false,
            tension: 0.1,
            pointRadius: 0
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: { duration: 0 },
        interaction: { intersect: false, mode: 'index' },
        scales: { y: { beginAtZero: true } },
        plugins: {
          legend: { display: true }
        }
      }
    });

    const profitCtx = document.getElementById('profitChart').getContext('2d');
    profitChart = new Chart(profitCtx, {
      type: 'line',
      data: {
        labels: initialDates,
        datasets: [
          {
            label: 'Daily Profit (KES)',
            data: initialProfitsData,
            borderColor: 'rgb(34, 197, 94)',
            backgroundColor: 'rgba(34, 197, 94, 0.1)',
            tension: 0.1,
            fill: true
          },
          {
            label: 'Trend Line',
            data: initialTrendProfits,
            borderColor: 'rgb(34, 197, 94)',
            borderDash: [5, 5],
            fill: false,
            tension: 0.1,
            pointRadius: 0
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: { duration: 0 },
        interaction: { intersect: false, mode: 'index' },
        scales: { y: { beginAtZero: false } },
        plugins: {
          legend: { display: true }
        }
      }
    });

    const topProductsCtx = document.getElementById('topProductsChart').getContext('2d');
    topProductsChart = new Chart(topProductsCtx, {
      type: 'pie',
      data: {
        labels: initialProductNames,
        datasets: [{
          data: initialProductRevenues,
          backgroundColor: [
            'rgb(255, 99, 132)', 'rgb(54, 162, 235)', 'rgb(255, 205, 86)', 'rgb(75, 192, 192)',
            'rgb(153, 102, 255)', 'rgb(255, 159, 64)', 'rgb(199, 199, 199)', 'rgb(83, 102, 255)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: { duration: 0 },
        interaction: { intersect: false },
        plugins: { legend: { position: 'bottom' } },
        onClick: (e, elements) => {
          if (elements.length > 0) {
            const index = elements[0].index;
            const productName = topProductsChart.data.labels[index];
            const stockRows = document.querySelectorAll('#stock-table tbody tr');
            let visibleCount = 0;
            stockRows.forEach(row => {
              if (row.style.display !== 'none') {
                const cellText = row.cells[1].textContent.toLowerCase();
                if (cellText.includes(productName.toLowerCase())) {
                  row.style.display = '';
                  visibleCount++;
                } else {
                  row.style.display = 'none';
                }
              }
            });
            if (visibleCount === 0) {
              alert(`No stock data found for "${productName}".`);
            }
            displayPage('stock-table');
          }
        }
      }
    });

    // Real-time update function
    function updateCharts() {
      fetch(window.location.href, {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      })
      .then(response => response.json())
      .then(data => {
        const newDates = data.daily_data.map(d => d.date);
        const hasNewData = newDates.length > 0;

        toggleChartVisibility('sales-chart-container', 'salesChart', 'sales-no-data', hasNewData);
        if (hasNewData && salesChart) {
          salesChart.data.labels = newDates;
          salesChart.data.datasets[0].data = data.daily_data.map(d => parseFloat(d.sales));
          salesChart.data.datasets[1].data = data.trend_sales;
          salesChart.update('none');
        }

        toggleChartVisibility('profit-chart-container', 'profitChart', 'profit-no-data', hasNewData);
        if (hasNewData && profitChart) {
          profitChart.data.labels = newDates;
          profitChart.data.datasets[0].data = data.daily_data.map(d => parseFloat(d.profit));
          profitChart.data.datasets[1].data = data.trend_profits;
          profitChart.update('none');
        }

        const hasProductsData = data.most_selling.length > 0;
        toggleChartVisibility('top-products-chart-container', 'topProductsChart', 'top-products-no-data', hasProductsData);
        if (hasProductsData && topProductsChart) {
          topProductsChart.data.labels = data.most_selling.map(p => p.name);
          topProductsChart.data.datasets[0].data = data.most_selling.map(p => parseFloat(p.revenue));
          topProductsChart.update('none');
        }
      })
      .catch(error => console.error('Error updating charts:', error));
    }

    setInterval(updateCharts, 30000);

    // Other event listeners
    document.getElementById('stock-search')?.addEventListener('input', e => filterTable('stock-table', e.target.value));
    document.getElementById('low-stock-search')?.addEventListener('input', e => filterTable('low-stock-table', e.target.value));
    document.getElementById('expiry-search')?.addEventListener('input', e => filterTable('expiry-table', e.target.value));

    document.getElementById('alert-type').addEventListener('change', applyFilters);
    document.getElementById('branch').addEventListener('change', () => document.getElementById('filter-form').submit());
    document.getElementById('date-range').addEventListener('change', function() {
      const customDate = document.getElementById('custom-date');
      const customDateEnd = document.getElementById('custom-date-end');
      if (this.value === 'custom') {
        customDate.classList.remove('hidden');
        customDateEnd.classList.remove('hidden');
      } else {
        customDate.classList.add('hidden');
        customDateEnd.classList.add('hidden');
      }
    });

    // Collapsible
    document.querySelectorAll('.collapsible-header').forEach(header => {
      header.addEventListener('click', () => {
        const content = header.nextElementSibling;
        const icon = header.querySelector('.toggle-icon');
        content.classList.toggle('active');
        icon.innerHTML = content.classList.contains('active') ?
          '<path d="M7 10l5 5 5-5z"/>' :
          '<path d="M7 14l5-5 5 5z"/>';
      });
    });

    window.addEventListener('load', applyFilters);
  });

  function applyFilters() {
    const alertType = document.getElementById('alert-type').value;
    document.getElementById('low-stock-container').style.display = alertType === '' || alertType === 'low_stock' ? '' : 'none';
    document.getElementById('expiry-container').style.display = alertType === '' || alertType === 'expiry' ? '' : 'none';
  }

  function resetFilters() {
    document.getElementById('date-range').value = 'today';
    document.getElementById('start-date').value = '';
    document.getElementById('end-date').value = '';
    document.getElementById('branch').value = '';
    document.getElementById('alert-type').value = '';
    document.getElementById('custom-date').classList.add('hidden');
    document.getElementById('custom-date-end').classList.add('hidden');
    document.getElementById('filter-form').submit();
  }
</script>
{% endblock %}